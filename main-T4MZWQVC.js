import{$ as X,A as Q,Aa as K,Ab as _,B as we,Ba as L,Bb as Ie,Ca as dt,Cb as mt,Db as kt,Eb as It,Fb as yt,G as D,Ga as Oe,Gb as je,Hb as bt,I as T,Ia as $e,Ib as Ve,J as Fe,Ja as ke,L as f,Lb as Rt,Mb as ee,N as ot,Nb as Dt,Ob as At,P as a,Pb as Et,Q as at,Qb as Ct,Rb as ye,S as Ue,Sb as Tt,T as Me,X as U,Xa as Z,Y as We,Ya as gt,b as ce,c as ge,cb as ft,d as fe,e as tt,ea as ct,eb as x,g as pe,h as g,i as p,j as rt,ja as Y,k as st,ka as lt,l as m,ma as ut,mb as pt,n as N,na as me,p as G,q as ve,ra as ht,s as it,t as C,ta as xe,u as I,ub as vt,w as le,x as nt,xb as He,y as Se,yb as St,za as ue,zb as wt}from"./chunk-6FH35LUJ.js";import{a as y,b as de}from"./chunk-QEZ3K4DX.js";function ir(){let i=globalThis.crypto;return i&&"randomUUID"in i&&typeof i.randomUUID=="function"?i.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,s=>{let d=Math.random()*16|0;return(s==="x"?d:d&3|8).toString(16)})}var Pt=(i,s)=>{let d=i.headers.has("X-Correlation-Id"),e=d?i.headers.get("X-Correlation-Id"):ir(),t=Date.now(),r=d?i:i.clone({headers:i.headers.set("X-Correlation-Id",e)});return s(r).pipe(T({next:()=>{},error:()=>{}}),Se(()=>{let n=Date.now()-t;console.debug("[HTTP]",r.method,r.urlWithParams,{correlationId:e,durationMs:n})}))};var Ft={chars:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bits:6};var Ut={parse:function(s,d){return nr(s,Ft,d)},stringify:function(s,d){return or(s,Ft,d)}};function nr(i,s,d){var e;if(d===void 0&&(d={}),!s.codes){s.codes={};for(var t=0;t<s.chars.length;++t)s.codes[s.chars[t]]=t}if(!d.loose&&i.length*s.bits&7)throw new SyntaxError("Invalid padding");for(var r=i.length;i[r-1]==="=";)if(--r,!d.loose&&!((i.length-r)*s.bits&7))throw new SyntaxError("Invalid padding");for(var n=new((e=d.out)!=null?e:Uint8Array)(r*s.bits/8|0),o=0,c=0,l=0,u=0;u<r;++u){var h=s.codes[i[u]];if(h===void 0)throw new SyntaxError("Invalid character "+i[u]);c=c<<s.bits|h,o+=s.bits,o>=8&&(o-=8,n[l++]=255&c>>o)}if(o>=s.bits||255&c<<8-o)throw new SyntaxError("Unexpected end of data");return n}function or(i,s,d){d===void 0&&(d={});for(var e=d,t=e.pad,r=t===void 0?!0:t,n=(1<<s.bits)-1,o="",c=0,l=0,u=0;u<i.length;++u)for(l=l<<8|255&i[u],c+=8;c>s.bits;)c-=s.bits,o+=s.chars[n&l>>c];if(c&&(o+=s.chars[n&l<<s.bits-c]),r)for(;o.length*s.bits&7;)o+="=";return o}function Ne(i,s){let e=!s?.manualCleanup?s?.injector?.get(We)??a(We):null,t=ar(s?.equal),r;s?.requireSync?r=X({kind:0},{equal:t}):r=X({kind:1,value:s?.initialValue},{equal:t});let n,o=i.subscribe({next:c=>r.set({kind:1,value:c}),error:c=>{r.set({kind:2,error:c}),n?.()},complete:()=>{n?.()}});if(s?.requireSync&&r().kind===0)throw new Fe(601,!1);return n=e?.onDestroy(o.unsubscribe.bind(o)),x(()=>{let c=r();switch(c.kind){case 1:return c.value;case 2:throw c.error;case 0:throw new Fe(601,!1)}},{equal:s?.equal})}function ar(i=Object.is){return(s,d)=>s.kind===1&&d.kind===1&&i(s.value,d.value)}var be=class{},Le=class{constructor(s){this.passedConfigs=s}loadConfigs(){return Array.isArray(this.passedConfigs)?g(this.passedConfigs):g([this.passedConfigs])}};function cr(i){if(!i?.config)throw new Error("No config provided!");return new Le(i.config)}var Mt=new ot("PASSED_CONFIG"),Ht=(()=>{let s=class s{};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),lr=(()=>{let s=class s{logError(e,...t){console.error(e,...t)}logWarning(e,...t){console.warn(e,...t)}logDebug(e,...t){console.debug(e,...t)}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),z=function(i){return i[i.None=0]="None",i[i.Debug=1]="Debug",i[i.Warn=2]="Warn",i[i.Error=3]="Error",i}(z||{}),S=(()=>{let s=class s{constructor(){this.abstractLoggerService=a(Ht)}logError(e,t,...r){if(this.loggingIsTurnedOff(e))return;let{configId:n}=e,o=this.isObject(t)?JSON.stringify(t):t;r&&r.length?this.abstractLoggerService.logError(`[ERROR] ${n} - ${o}`,...r):this.abstractLoggerService.logError(`[ERROR] ${n} - ${o}`)}logWarning(e,t,...r){if(!this.logLevelIsSet(e)||this.loggingIsTurnedOff(e)||!this.currentLogLevelIsEqualOrSmallerThan(e,z.Warn))return;let{configId:n}=e,o=this.isObject(t)?JSON.stringify(t):t;r&&r.length?this.abstractLoggerService.logWarning(`[WARN] ${n} - ${o}`,...r):this.abstractLoggerService.logWarning(`[WARN] ${n} - ${o}`)}logDebug(e,t,...r){if(!e||!this.logLevelIsSet(e)||this.loggingIsTurnedOff(e)||!this.currentLogLevelIsEqualOrSmallerThan(e,z.Debug))return;let{configId:n}=e,o=this.isObject(t)?JSON.stringify(t):t;r&&r.length?this.abstractLoggerService.logDebug(`[DEBUG] ${n} - ${o}`,...r):this.abstractLoggerService.logDebug(`[DEBUG] ${n} - ${o}`)}currentLogLevelIsEqualOrSmallerThan(e,t){let{logLevel:r}=e||{};return r?r<=t:!1}logLevelIsSet(e){let{logLevel:t}=e||{};return t===null?!1:t!==void 0}loggingIsTurnedOff(e){let{logLevel:t}=e||{};return t===z.None}isObject(e){return Object.prototype.toString.call(e)==="[object Object]"}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),P=function(i){return i[i.ConfigLoaded=0]="ConfigLoaded",i[i.CheckingAuth=1]="CheckingAuth",i[i.CheckingAuthFinished=2]="CheckingAuthFinished",i[i.CheckingAuthFinishedWithError=3]="CheckingAuthFinishedWithError",i[i.ConfigLoadingFailed=4]="ConfigLoadingFailed",i[i.CheckSessionReceived=5]="CheckSessionReceived",i[i.UserDataChanged=6]="UserDataChanged",i[i.NewAuthenticationResult=7]="NewAuthenticationResult",i[i.TokenExpired=8]="TokenExpired",i[i.IdTokenExpired=9]="IdTokenExpired",i[i.SilentRenewStarted=10]="SilentRenewStarted",i[i.SilentRenewFailed=11]="SilentRenewFailed",i}(P||{}),B=(()=>{let s=class s{constructor(){this.notify=new tt(1)}fireEvent(e,t){this.notify.next({type:e,value:t})}registerForEvents(){return this.notify.asObservable()}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),jt=(()=>{let s=class s{};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),ur=(()=>{let s=class s{constructor(){this.loggerService=a(S),this.abstractSecurityStorage=a(jt)}read(e,t){let{configId:r}=t;if(!r)return this.loggerService.logDebug(t,`Wanted to read '${e}' but configId was '${r}'`),null;if(!this.hasStorage())return this.loggerService.logDebug(t,`Wanted to read '${e}' but Storage was undefined`),null;let n=this.abstractSecurityStorage.read(r);return n?JSON.parse(n):null}write(e,t){let{configId:r}=t;return r?this.hasStorage()?(e=e||null,this.abstractSecurityStorage.write(r,JSON.stringify(e)),!0):(this.loggerService.logDebug(t,"Wanted to write but Storage was falsy"),!1):(this.loggerService.logDebug(t,`Wanted to write but configId was '${r}'`),!1)}remove(e,t){return this.hasStorage()?(this.abstractSecurityStorage.remove(e),!0):(this.loggerService.logDebug(t,`Wanted to remove '${e}' but Storage was falsy`),!1)}clear(e){return this.hasStorage()?(this.abstractSecurityStorage.clear(),!0):(this.loggerService.logDebug(e,"Wanted to clear storage but Storage was falsy"),!1)}hasStorage(){return typeof Storage<"u"}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),E=(()=>{let s=class s{constructor(){this.browserStorageService=a(ur)}read(e,t){return(this.browserStorageService.read(e,t)||{})[e]}write(e,t,r){let n=this.browserStorageService.read(e,r)||{};return n[e]=t,this.browserStorageService.write(n,r)}remove(e,t){let r=this.browserStorageService.read(e,t)||{};delete r[e],this.browserStorageService.write(r,t)}clear(e){this.browserStorageService.clear(e)}resetStorageFlowData(e){this.remove("session_state",e),this.remove("storageSilentRenewRunning",e),this.remove("storageCodeFlowInProgress",e),this.remove("codeVerifier",e),this.remove("userData",e),this.remove("storageCustomParamsAuthRequest",e),this.remove("access_token_expires_at",e),this.remove("storageCustomParamsRefresh",e),this.remove("storageCustomParamsEndSession",e),this.remove("reusable_refresh_token",e)}resetAuthStateInStorage(e){this.remove("authzData",e),this.remove("reusable_refresh_token",e),this.remove("authnResult",e)}getAccessToken(e){return this.read("authzData",e)}getIdToken(e){return this.read("authnResult",e)?.id_token}getRefreshToken(e){let t=this.read("authnResult",e)?.refresh_token;return!t&&e.allowUnsafeReuseRefreshToken?this.read("reusable_refresh_token",e):t}getAuthenticationResult(e){return this.read("authnResult",e)}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),Vt=(()=>{let s=class s{extractJwk(e,t,r=!0){if(e.length===0)throw hr;let n=e.filter(o=>t?.kid?o.kid===t.kid:!0).filter(o=>t?.use?o.use===t.use:!0).filter(o=>t?.kty?o.kty===t.kty:!0);if(n.length===0&&r)throw dr;if(n.length>1&&t==null)throw gr;return n}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})();function qe(i){return Vt.name+": "+i}var hr={name:qe("InvalidArgumentError"),message:"Array of keys was empty. Unable to extract"},dr={name:qe("NoMatchingKeysError"),message:"No key found matching the spec"},gr={name:qe("SeveralMatchingKeysError"),message:"More than one key found. Please use spec to filter"},Wt=3,De=(()=>{let s=class s{constructor(){this.loggerService=a(S),this.document=a(U)}getTokenExpirationDate(e){if(!Object.prototype.hasOwnProperty.call(e,"exp"))return new Date(new Date().toUTCString());let t=new Date(0);return t.setUTCSeconds(e.exp),t}getSigningInputFromToken(e,t,r){if(!this.tokenIsValid(e,r))return"";let n=this.getHeaderFromToken(e,t,r),o=this.getPayloadFromToken(e,t,r);return[n,o].join(".")}getHeaderFromToken(e,t,r){return this.tokenIsValid(e,r)?this.getPartOfToken(e,0,t):{}}getPayloadFromToken(e,t,r){return r?this.tokenIsValid(e,r)?this.getPartOfToken(e,1,t):{}:{}}getSignatureFromToken(e,t,r){return this.tokenIsValid(e,r)?this.getPartOfToken(e,2,t):{}}getPartOfToken(e,t,r){let n=this.extractPartOfToken(e,t);if(r)return n;let o=this.urlBase64Decode(n);return JSON.parse(o)}urlBase64Decode(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw Error("Illegal base64url string!")}let r=typeof this.document.defaultView<"u"?this.document.defaultView?.atob(t):Buffer.from(t,"base64").toString("binary");if(!r)return"";try{return decodeURIComponent(r.split("").map(n=>"%"+("00"+n.charCodeAt(0).toString(16)).slice(-2)).join(""))}catch{return r}}tokenIsValid(e,t){return e?e.includes(".")?e.split(".").length!==Wt?(this.loggerService.logError(t,`token '${e}' is not valid --> token has to have exactly ${Wt-1} dots`),!1):!0:(this.loggerService.logError(t,`token '${e}' is not valid --> no dots included`),!1):(this.loggerService.logError(t,`token '${e}' is not valid --> token falsy`),!1)}extractPartOfToken(e,t){return e.split(".")[t]}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),Je=(()=>{let s=class s{constructor(){this.document=a(U)}getCrypto(){return this.document.defaultView?.crypto||this.document.defaultView?.msCrypto}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),fr=(()=>{let s=class s{constructor(){this.cryptoService=a(Je)}importVerificationKey(e,t){return this.cryptoService.getCrypto().subtle.importKey("jwk",e,t,!1,["verify"])}verifyKey(e,t,r,n){return this.cryptoService.getCrypto().subtle.verify(e,t,r,new TextEncoder().encode(n))}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),Nt=(()=>{let s=class s{constructor(){this.cryptoService=a(Je)}generateCodeChallenge(e){return this.calcHash(e).pipe(m(t=>this.base64UrlEncode(t)))}generateAtHash(e,t){return this.calcHash(e,t).pipe(m(r=>{let n=r.substr(0,r.length/2);return btoa(n).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}))}calcHash(e,t="SHA-256"){let r=new TextEncoder().encode(e);return pe(this.cryptoService.getCrypto().subtle.digest(t,r)).pipe(m(n=>{let o=n,c=Array.from(new Uint8Array(o));return this.toHashString(c)}))}toHashString(e){let t="";for(let r of e)t+=String.fromCharCode(r);return t}base64UrlEncode(e){return btoa(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})();function pr(i){switch(i.charAt(0)){case"R":return{name:"RSASSA-PKCS1-v1_5",hash:"SHA-256"};case"E":return i.includes("256")?{name:"ECDSA",hash:"SHA-256"}:i.includes("384")?{name:"ECDSA",hash:"SHA-384"}:null;default:return null}}function vr(i){switch(i.charAt(0)){case"R":return"RSA";case"E":return"EC";default:throw new Error("Cannot infer kty from alg: "+i)}}function Sr(i){switch(i.charAt(0)){case"R":return i.includes("256")?{name:"RSASSA-PKCS1-v1_5",hash:"SHA-256"}:i.includes("384")?{name:"RSASSA-PKCS1-v1_5",hash:"SHA-384"}:i.includes("512")?{name:"RSASSA-PKCS1-v1_5",hash:"SHA-512"}:null;case"E":return i.includes("256")?{name:"ECDSA",namedCurve:"P-256"}:i.includes("384")?{name:"ECDSA",namedCurve:"P-384"}:null;default:return null}}var Ae=(()=>{let s=class s{constructor(){this.keyAlgorithms=["HS256","HS384","HS512","RS256","RS384","RS512","ES256","ES384","PS256","PS384","PS512"],this.tokenHelperService=a(De),this.loggerService=a(S),this.jwkExtractor=a(Vt),this.jwkWindowCryptoService=a(fr),this.jwtWindowCryptoService=a(Nt)}hasIdTokenExpired(e,t,r){let n=this.tokenHelperService.getPayloadFromToken(e,!1,t);return!this.validateIdTokenExpNotExpired(n,t,r)}validateIdTokenExpNotExpired(e,t,r){let n=this.tokenHelperService.getTokenExpirationDate(e);if(r=r||0,!n)return!1;let o=n.valueOf(),c=this.calculateNowWithOffset(r),l=o>c;return this.loggerService.logDebug(t,`Has idToken expired: ${!l} --> expires in ${this.millisToMinutesAndSeconds(o-c)} , ${new Date(o).toLocaleTimeString()} > ${new Date(c).toLocaleTimeString()}`),l}validateAccessTokenNotExpired(e,t,r){if(!e)return!0;r=r||0;let n=e.valueOf(),o=this.calculateNowWithOffset(r),c=n>o;return this.loggerService.logDebug(t,`Has accessToken expired: ${!c} --> expires in ${this.millisToMinutesAndSeconds(n-o)} , ${new Date(n).toLocaleTimeString()} > ${new Date(o).toLocaleTimeString()}`),c}validateRequiredIdToken(e,t){let r=!0;return Object.prototype.hasOwnProperty.call(e,"iss")||(r=!1,this.loggerService.logWarning(t,"iss is missing, this is required in the id_token")),Object.prototype.hasOwnProperty.call(e,"sub")||(r=!1,this.loggerService.logWarning(t,"sub is missing, this is required in the id_token")),Object.prototype.hasOwnProperty.call(e,"aud")||(r=!1,this.loggerService.logWarning(t,"aud is missing, this is required in the id_token")),Object.prototype.hasOwnProperty.call(e,"exp")||(r=!1,this.loggerService.logWarning(t,"exp is missing, this is required in the id_token")),Object.prototype.hasOwnProperty.call(e,"iat")||(r=!1,this.loggerService.logWarning(t,"iat is missing, this is required in the id_token")),r}validateIdTokenIatMaxOffset(e,t,r,n){if(r)return!0;if(!Object.prototype.hasOwnProperty.call(e,"iat"))return!1;let o=new Date(0);o.setUTCSeconds(e.iat),t=t||0;let l=new Date(new Date().toUTCString()).valueOf()-o.valueOf(),u=t*1e3;return this.loggerService.logDebug(n,`validate id token iat max offset ${l} < ${u}`),l>0?l<u:-l<u}validateIdTokenNonce(e,t,r,n){return!((e.nonce===void 0||r)&&t===s.refreshTokenNoncePlaceholder)&&e.nonce!==t?(this.loggerService.logDebug(n,"Validate_id_token_nonce failed, dataIdToken.nonce: "+e.nonce+" local_nonce:"+t),!1):!0}validateIdTokenIss(e,t,r){return e.iss!==t?(this.loggerService.logDebug(r,"Validate_id_token_iss failed, dataIdToken.iss: "+e.iss+" authWellKnownEndpoints issuer:"+t),!1):!0}validateIdTokenAud(e,t,r){return Array.isArray(e.aud)?e.aud.includes(t)?!0:(this.loggerService.logDebug(r,"Validate_id_token_aud array failed, dataIdToken.aud: "+e.aud+" client_id:"+t),!1):e.aud!==t?(this.loggerService.logDebug(r,"Validate_id_token_aud failed, dataIdToken.aud: "+e.aud+" client_id:"+t),!1):!0}validateIdTokenAzpExistsIfMoreThanOneAud(e){return e?!(Array.isArray(e.aud)&&e.aud.length>1&&!e.azp):!1}validateIdTokenAzpValid(e,t){return e?.azp?e.azp===t:!0}validateStateFromHashCallback(e,t,r){return e!==t?(this.loggerService.logDebug(r,"ValidateStateFromHashCallback failed, state: "+e+" local_state:"+t),!1):!0}validateSignatureIdToken(e,t,r){if(!e)return g(!0);if(!t||!t.keys)return g(!1);let n=this.tokenHelperService.getHeaderFromToken(e,!1,r);if(Object.keys(n).length===0&&n.constructor===Object)return this.loggerService.logWarning(r,"id token has no header data"),g(!1);let o=n.kid,c=n.alg,l=t.keys,u,h;if(!this.keyAlgorithms.includes(c))return this.loggerService.logWarning(r,"alg not supported",c),g(!1);let v=vr(c),k="sig";try{u=o?this.jwkExtractor.extractJwk(l,{kid:o,kty:v,use:k},!1):this.jwkExtractor.extractJwk(l,{kty:v,use:k},!1),u.length===0&&(u=o?this.jwkExtractor.extractJwk(l,{kid:o,kty:v}):this.jwkExtractor.extractJwk(l,{kty:v})),h=u[0]}catch(M){return this.loggerService.logError(r,M),g(!1)}let A=Sr(c),w=this.tokenHelperService.getSigningInputFromToken(e,!0,r),j=this.tokenHelperService.getSignatureFromToken(e,!0,r);return pe(this.jwkWindowCryptoService.importVerificationKey(h,A)).pipe(N(M=>{let V=Ut.parse(j,{loose:!0}),ae=pr(c);return pe(this.jwkWindowCryptoService.verifyKey(ae,M,V,w))}),T(M=>{M||this.loggerService.logWarning(r,"incorrect Signature, validation failed for id_token")}))}validateIdTokenAtHash(e,t,r,n){this.loggerService.logDebug(n,"at_hash from the server:"+t);let o="SHA-256";return r.includes("384")?o="SHA-384":r.includes("512")&&(o="SHA-512"),this.jwtWindowCryptoService.generateAtHash(""+e,o).pipe(N(c=>(this.loggerService.logDebug(n,"at_hash client validation not decoded:"+c),c===t?g(!0):this.jwtWindowCryptoService.generateAtHash(""+decodeURIComponent(e),o).pipe(m(l=>(this.loggerService.logDebug(n,"-gen access--"+c),l===t))))))}millisToMinutesAndSeconds(e){let t=Math.floor(e/6e4),r=(e%6e4/1e3).toFixed(0);return t+":"+(+r<10?"0":"")+r}calculateNowWithOffset(e){return new Date(new Date().toUTCString()).valueOf()+e*1e3}};s.refreshTokenNoncePlaceholder="--RefreshToken--",s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),wr={isAuthenticated:!1,allConfigsAuthenticated:[]},W=(()=>{let s=class s{constructor(){this.storagePersistenceService=a(E),this.loggerService=a(S),this.publicEventsService=a(B),this.tokenValidationService=a(Ae),this.authenticatedInternal$=new fe(wr)}get authenticated$(){return this.authenticatedInternal$.asObservable().pipe(nt())}setAuthenticatedAndFireEvent(e){let t=this.composeAuthenticatedResult(e);this.authenticatedInternal$.next(t)}setUnauthenticatedAndFireEvent(e,t){this.storagePersistenceService.resetAuthStateInStorage(e);let r=this.composeUnAuthenticatedResult(t);this.authenticatedInternal$.next(r)}updateAndPublishAuthState(e){this.publicEventsService.fireEvent(P.NewAuthenticationResult,e)}setAuthorizationData(e,t,r,n){this.loggerService.logDebug(r,`storing the accessToken '${e}'`),this.storagePersistenceService.write("authzData",e,r),this.persistAccessTokenExpirationTime(t,r),this.setAuthenticatedAndFireEvent(n)}getAccessToken(e){if(!e||!this.isAuthenticated(e))return"";let t=this.storagePersistenceService.getAccessToken(e);return this.decodeURIComponentSafely(t)}getIdToken(e){if(!e||!this.isAuthenticated(e))return"";let t=this.storagePersistenceService.getIdToken(e);return this.decodeURIComponentSafely(t)}getRefreshToken(e){if(!e||!this.isAuthenticated(e))return"";let t=this.storagePersistenceService.getRefreshToken(e);return this.decodeURIComponentSafely(t)}getAuthenticationResult(e){return!e||!this.isAuthenticated(e)?null:this.storagePersistenceService.getAuthenticationResult(e)}areAuthStorageTokensValid(e){return!e||!this.isAuthenticated(e)?!1:this.hasIdTokenExpiredAndRenewCheckIsEnabled(e)?(this.loggerService.logDebug(e,"persisted idToken is expired"),!1):this.hasAccessTokenExpiredIfExpiryExists(e)?(this.loggerService.logDebug(e,"persisted accessToken is expired"),!1):(this.loggerService.logDebug(e,"persisted idToken and accessToken are valid"),!0)}hasIdTokenExpiredAndRenewCheckIsEnabled(e){let{renewTimeBeforeTokenExpiresInSeconds:t,triggerRefreshWhenIdTokenExpired:r,disableIdTokenValidation:n}=e;if(!r||n)return!1;let o=this.storagePersistenceService.getIdToken(e),c=this.tokenValidationService.hasIdTokenExpired(o,e,t);return c&&this.publicEventsService.fireEvent(P.IdTokenExpired,c),c}hasAccessTokenExpiredIfExpiryExists(e){let{renewTimeBeforeTokenExpiresInSeconds:t}=e,r=this.storagePersistenceService.read("access_token_expires_at",e),o=!this.tokenValidationService.validateAccessTokenNotExpired(r,e,t);return o&&this.publicEventsService.fireEvent(P.TokenExpired,o),o}isAuthenticated(e){if(!e)return p(()=>new Error("Please provide a configuration before setting up the module")),!1;let t=!!this.storagePersistenceService.getAccessToken(e),r=!!this.storagePersistenceService.getIdToken(e);return t&&r}decodeURIComponentSafely(e){return e?decodeURIComponent(e):""}persistAccessTokenExpirationTime(e,t){if(e?.expires_in){let r=new Date(new Date().toUTCString()).valueOf()+e.expires_in*1e3;this.storagePersistenceService.write("access_token_expires_at",r,t)}}composeAuthenticatedResult(e){if(e.length===1){let{configId:t}=e[0];return{isAuthenticated:!0,allConfigsAuthenticated:[{configId:t??"",isAuthenticated:!0}]}}return this.checkAllConfigsIfTheyAreAuthenticated(e)}composeUnAuthenticatedResult(e){if(e.length===1){let{configId:t}=e[0];return{isAuthenticated:!1,allConfigsAuthenticated:[{configId:t??"",isAuthenticated:!1}]}}return this.checkAllConfigsIfTheyAreAuthenticated(e)}checkAllConfigsIfTheyAreAuthenticated(e){let t=e.map(n=>({configId:n.configId??"",isAuthenticated:this.isAuthenticated(n)})),r=t.every(n=>n.isAuthenticated);return{allConfigsAuthenticated:t,isAuthenticated:r}}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),Ke="redirect",mr=(()=>{let s=class s{constructor(){this.storageService=a(E),this.router=a(ee)}checkSavedRedirectRouteAndNavigate(e){if(!e)return;let t=this.getStoredRedirectRoute(e);t!=null&&(this.deleteStoredRedirectRoute(e),this.router.navigateByUrl(t))}saveRedirectRoute(e,t){e&&this.storageService.write(Ke,t,e)}getStoredRedirectRoute(e){return this.storageService.read(Ke,e)}deleteStoredRedirectRoute(e){this.storageService.remove(Ke,e)}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),$=(()=>{let s=class s{isCurrentFlowCodeFlow(e){return this.currentFlowIs("code",e)}isCurrentFlowAnyImplicitFlow(e){return this.isCurrentFlowImplicitFlowWithAccessToken(e)||this.isCurrentFlowImplicitFlowWithoutAccessToken(e)}isCurrentFlowCodeFlowWithRefreshTokens(e){if(!e)return!1;let{useRefreshToken:t}=e;return this.isCurrentFlowCodeFlow(e)&&!!t}isCurrentFlowImplicitFlowWithAccessToken(e){return this.currentFlowIs("id_token token",e)}currentFlowIs(e,t){let{responseType:r}=t;return Array.isArray(e)?e.some(n=>r===n):r===e}isCurrentFlowImplicitFlowWithoutAccessToken(e){return this.currentFlowIs("id_token",e)}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),kr=(()=>{let s=class s{constructor(){this.loggerService=a(S),this.cryptoService=a(Je)}createRandom(e,t){if(e<=0)return"";e>0&&e<7&&(this.loggerService.logWarning(t,`RandomService called with ${e} but 7 chars is the minimum, returning 10 chars`),e=10);let r=e-6,n=new Uint8Array(Math.floor(r/2)),o=this.cryptoService.getCrypto();return o&&o.getRandomValues(n),Array.from(n,this.toHex).join("")+this.randomString(7)}toHex(e){return("0"+e.toString(16)).substr(-2)}randomString(e){let t="",r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=new Uint32Array(e),o=this.cryptoService.getCrypto();if(o){o.getRandomValues(n);for(let c=0;c<e;c++)t+=r[n[c]%r.length]}return t}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),F=(()=>{let s=class s{constructor(){this.loggerService=a(S),this.storagePersistenceService=a(E),this.randomService=a(kr)}createNonce(e){let t=this.randomService.createRandom(40,e);return this.loggerService.logDebug(e,"Nonce created. nonce:"+t),this.setNonce(t,e),t}setNonce(e,t){this.storagePersistenceService.write("authNonce",e,t)}getAuthStateControl(e){return e?this.storagePersistenceService.read("authStateControl",e):""}setAuthStateControl(e,t){return t?this.storagePersistenceService.write("authStateControl",e,t):!1}getExistingOrCreateAuthStateControl(e){let t=this.storagePersistenceService.read("authStateControl",e);return t||(t=this.randomService.createRandom(40,e),this.storagePersistenceService.write("authStateControl",t,e)),t}setSessionState(e,t){this.storagePersistenceService.write("session_state",e,t)}resetStorageFlowData(e){this.storagePersistenceService.resetStorageFlowData(e)}getCodeVerifier(e){return this.storagePersistenceService.read("codeVerifier",e)}createCodeVerifier(e){let t=this.randomService.createRandom(67,e);return this.storagePersistenceService.write("codeVerifier",t,e),t}isCodeFlowInProgress(e){return!!this.storagePersistenceService.read("storageCodeFlowInProgress",e)}setCodeFlowInProgress(e){this.storagePersistenceService.write("storageCodeFlowInProgress",!0,e)}resetCodeFlowInProgress(e){this.storagePersistenceService.write("storageCodeFlowInProgress",!1,e)}isSilentRenewRunning(e){let{configId:t,silentRenewTimeoutInSeconds:r}=e,n=this.getSilentRenewRunningStorageEntry(e);if(!n||n.state==="not-running")return!1;let o=(r??0)*1e3,c=Date.parse(n.dateOfLaunchedProcessUtc),l=Date.parse(new Date().toISOString());return Math.abs(l-c)>o?(this.loggerService.logDebug(e,"silent renew process is probably stuck, state will be reset.",t),this.resetSilentRenewRunning(e),!1):n.state==="running"}setSilentRenewRunning(e){let t={state:"running",dateOfLaunchedProcessUtc:new Date().toISOString()};this.storagePersistenceService.write("storageSilentRenewRunning",JSON.stringify(t),e)}resetSilentRenewRunning(e){e&&this.storagePersistenceService.write("storageSilentRenewRunning","",e)}getSilentRenewRunningStorageEntry(e){let t=this.storagePersistenceService.read("storageSilentRenewRunning",e);return t?JSON.parse(t):{dateOfLaunchedProcessUtc:"",state:"not-running"}}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),ze=class{encodeKey(s){return encodeURIComponent(s)}encodeValue(s){return encodeURIComponent(s)}decodeKey(s){return decodeURIComponent(s)}decodeValue(s){return decodeURIComponent(s)}},Ir=["code","state","token","id_token"],yr="auth0.com",O=(()=>{let s=class s{constructor(){this.loggerService=a(S),this.flowsDataService=a(F),this.flowHelper=a($),this.storagePersistenceService=a(E),this.jwtWindowCryptoService=a(Nt)}getUrlParameter(e,t){if(!e||!t)return"";t=t.replace(/[[]/,"\\[").replace(/[\]]/,"\\]");let n=new RegExp("[\\?&#]"+t+"=([^&#]*)").exec(e);return n===null?"":decodeURIComponent(n[1])}getUrlWithoutQueryParameters(e){let t=new URL(e.toString()),r=[];for(let n of t.searchParams.keys())r.push(n);return r.forEach(n=>{t.searchParams.delete(n)}),t}queryParametersExist(e,t){let r=!0;return e.forEach((n,o)=>{t.has(o)||(r=!1)}),r}isCallbackFromSts(e,t){if(t&&t.checkRedirectUrlWhenCheckingIfIsCallback){let r=new URL(e),n=this.getRedirectUrl(t);if(!n)return this.loggerService.logError(t,"UrlService.isCallbackFromSts: could not get redirectUrl from config, was: ",n),!1;let o=new URL(n),c=this.getUrlWithoutQueryParameters(o).toString(),l=this.getUrlWithoutQueryParameters(r).toString(),u=this.queryParametersExist(o.searchParams,r.searchParams);if(c!==l||!u)return this.loggerService.logDebug(t,"UrlService.isCallbackFromSts: configured redirectUrl does not match with the current url"),!1}return Ir.some(r=>!!this.getUrlParameter(e,r))}getRefreshSessionSilentRenewUrl(e,t){return this.flowHelper.isCurrentFlowCodeFlow(e)?this.createUrlCodeFlowWithSilentRenew(e,t):g(this.createUrlImplicitFlowWithSilentRenew(e,t))}getAuthorizeParUrl(e,t){let r=this.storagePersistenceService.read("authWellKnownEndPoints",t);if(!r)return this.loggerService.logError(t,"authWellKnownEndpoints is undefined"),null;let n=r.authorizationEndpoint;if(!n)return this.loggerService.logError(t,`Can not create an authorize URL when authorizationEndpoint is '${n}'`),null;let{clientId:o}=t;if(!o)return this.loggerService.logError(t,"getAuthorizeParUrl could not add clientId because it was: ",o),null;let c=n.split("?"),l=c[0],u=c[1],h=this.createHttpParams(u);return h=h.set("request_uri",e),h=h.append("client_id",o),`${l}?${h}`}getAuthorizeUrl(e,t){return e?this.flowHelper.isCurrentFlowCodeFlow(e)?this.createUrlCodeFlowAuthorize(e,t):g(this.createUrlImplicitFlowAuthorize(e,t)||""):g(null)}getEndSessionEndpoint(e){let r=this.storagePersistenceService.read("authWellKnownEndPoints",e)?.endSessionEndpoint;if(!r)return{url:"",existingParams:""};let n=r.split("?"),o=n[0],c=n[1]??"";return{url:o,existingParams:c}}getEndSessionUrl(e,t){if(!e)return null;let r=this.storagePersistenceService.getIdToken(e),{customParamsEndSessionRequest:n}=e,o=y(y({},n),t);return this.createEndSessionUrl(r,e,o)}createRevocationEndpointBodyAccessToken(e,t){let r=this.getClientId(t);if(!r)return null;let n=this.createHttpParams();return n=n.set("client_id",r),n=n.set("token",e),n=n.set("token_type_hint","access_token"),n.toString()}createRevocationEndpointBodyRefreshToken(e,t){let r=this.getClientId(t);if(!r)return null;let n=this.createHttpParams();return n=n.set("client_id",r),n=n.set("token",e),n=n.set("token_type_hint","refresh_token"),n.toString()}getRevocationEndpointUrl(e){let r=this.storagePersistenceService.read("authWellKnownEndPoints",e)?.revocationEndpoint;return r?r.split("?")[0]:null}createBodyForCodeFlowCodeRequest(e,t,r){let n=this.getClientId(t);if(!n)return null;let o=this.createHttpParams();if(o=o.set("grant_type","authorization_code"),o=o.set("client_id",n),!t.disablePkce){let u=this.flowsDataService.getCodeVerifier(t);if(!u)return this.loggerService.logError(t,"CodeVerifier is not set ",u),null;o=o.set("code_verifier",u)}o=o.set("code",e),r&&(o=this.appendCustomParams(y({},r),o));let c=this.getSilentRenewUrl(t);if(this.flowsDataService.isSilentRenewRunning(t)&&c)return o=o.set("redirect_uri",c),o.toString();let l=this.getRedirectUrl(t);return l?(o=o.set("redirect_uri",l),o.toString()):null}createBodyForCodeFlowRefreshTokensRequest(e,t,r){let n=this.getClientId(t);if(!n)return null;let o=this.createHttpParams();return o=o.set("grant_type","refresh_token"),o=o.set("client_id",n),o=o.set("refresh_token",e),r&&(o=this.appendCustomParams(y({},r),o)),o.toString()}createBodyForParCodeFlowRequest(e,t){let r=this.getRedirectUrl(e,t);if(!r)return g(null);let n=this.flowsDataService.getExistingOrCreateAuthStateControl(e),o=this.flowsDataService.createNonce(e);this.loggerService.logDebug(e,"Authorize created. adding myautostate: "+n);let c=this.flowsDataService.createCodeVerifier(e);return this.jwtWindowCryptoService.generateCodeChallenge(c).pipe(m(l=>{let{clientId:u,responseType:h,scope:v,hdParam:k,customParamsAuthRequest:A}=e,w=this.createHttpParams("");return w=w.set("client_id",u??""),w=w.append("redirect_uri",r),w=w.append("response_type",h??""),w=w.append("scope",v??""),w=w.append("nonce",o),w=w.append("state",n),w=w.append("code_challenge",l),w=w.append("code_challenge_method","S256"),k&&(w=w.append("hd",k)),A&&(w=this.appendCustomParams(y({},A),w)),t?.customParams&&(w=this.appendCustomParams(y({},t.customParams),w)),w.toString()}))}getPostLogoutRedirectUrl(e){let{postLogoutRedirectUri:t}=e;return t||(this.loggerService.logError(e,"could not get postLogoutRedirectUri, was: ",t),null)}createEndSessionUrl(e,t,r){if(this.isAuth0Endpoint(t))return this.composeAuth0Endpoint(t);let{url:n,existingParams:o}=this.getEndSessionEndpoint(t);if(!n)return null;let c=this.createHttpParams(o);e&&(c=c.set("id_token_hint",e));let l=this.getPostLogoutRedirectUrl(t);return l&&(c=c.append("post_logout_redirect_uri",l)),r&&(c=this.appendCustomParams(y({},r),c)),`${n}?${c}`}createAuthorizeUrl(e,t,r,n,o,c,l){let h=this.storagePersistenceService.read("authWellKnownEndPoints",o)?.authorizationEndpoint;if(!h)return this.loggerService.logError(o,`Can not create an authorize URL when authorizationEndpoint is '${h}'`),"";let{clientId:v,responseType:k,scope:A,hdParam:w,customParamsAuthRequest:j}=o;if(!v)return this.loggerService.logError(o,"createAuthorizeUrl could not add clientId because it was: ",v),"";if(!k)return this.loggerService.logError(o,"createAuthorizeUrl could not add responseType because it was: ",k),"";if(!A)return this.loggerService.logError(o,"createAuthorizeUrl could not add scope because it was: ",A),"";let M=h.split("?"),V=M[0],ae=M[1],b=this.createHttpParams(ae);b=b.set("client_id",v),b=b.append("redirect_uri",t),b=b.append("response_type",k),b=b.append("scope",A),b=b.append("nonce",r),b=b.append("state",n),this.flowHelper.isCurrentFlowCodeFlow(o)&&(b=b.append("code_challenge",e),b=b.append("code_challenge_method","S256"));let et=y(y({},j),l);return Object.keys(et).length>0&&(b=this.appendCustomParams(y({},et),b)),c&&(b=this.overWriteParam(b,"prompt",c)),w&&(b=b.append("hd",w)),`${V}?${b}`}createUrlImplicitFlowWithSilentRenew(e,t){let r=this.flowsDataService.getExistingOrCreateAuthStateControl(e),n=this.flowsDataService.createNonce(e),o=this.getSilentRenewUrl(e);return o?(this.loggerService.logDebug(e,"RefreshSession created. adding myautostate: ",r),this.storagePersistenceService.read("authWellKnownEndPoints",e)?this.createAuthorizeUrl("",o,n,r,e,"none",t):(this.loggerService.logError(e,"authWellKnownEndpoints is undefined"),null)):null}createUrlCodeFlowWithSilentRenew(e,t){let r=this.flowsDataService.getExistingOrCreateAuthStateControl(e),n=this.flowsDataService.createNonce(e);this.loggerService.logDebug(e,"RefreshSession created. adding myautostate: "+r);let o=this.flowsDataService.createCodeVerifier(e);return this.jwtWindowCryptoService.generateCodeChallenge(o).pipe(m(c=>{let l=this.getSilentRenewUrl(e);return l?this.storagePersistenceService.read("authWellKnownEndPoints",e)?this.createAuthorizeUrl(c,l,n,r,e,"none",t):(this.loggerService.logWarning(e,"authWellKnownEndpoints is undefined"),""):""}))}createUrlImplicitFlowAuthorize(e,t){let r=this.flowsDataService.getExistingOrCreateAuthStateControl(e),n=this.flowsDataService.createNonce(e);this.loggerService.logDebug(e,"Authorize created. adding myautostate: "+r);let o=this.getRedirectUrl(e,t);if(!o)return null;if(this.storagePersistenceService.read("authWellKnownEndPoints",e)){let{customParams:l}=t||{};return this.createAuthorizeUrl("",o,n,r,e,"",l)}return this.loggerService.logError(e,"authWellKnownEndpoints is undefined"),null}createUrlCodeFlowAuthorize(e,t){let r=this.flowsDataService.getExistingOrCreateAuthStateControl(e),n=this.flowsDataService.createNonce(e);this.loggerService.logDebug(e,"Authorize created. adding myautostate: "+r);let o=this.getRedirectUrl(e,t);return o?this.getCodeChallenge(e).pipe(m(c=>{if(this.storagePersistenceService.read("authWellKnownEndPoints",e)){let{customParams:u}=t||{};return this.createAuthorizeUrl(c,o,n,r,e,"",u)}return this.loggerService.logError(e,"authWellKnownEndpoints is undefined"),""})):g(null)}getCodeChallenge(e){if(e.disablePkce)return g("");let t=this.flowsDataService.createCodeVerifier(e);return this.jwtWindowCryptoService.generateCodeChallenge(t)}getRedirectUrl(e,t){let{redirectUrl:r}=e;return t?.redirectUrl&&(r=t.redirectUrl),r||(this.loggerService.logError(e,"could not get redirectUrl, was: ",r),null)}getSilentRenewUrl(e){let{silentRenewUrl:t}=e;return t||(this.loggerService.logError(e,"could not get silentRenewUrl, was: ",t),null)}getClientId(e){let{clientId:t}=e;return t||(this.loggerService.logError(e,"could not get clientId, was: ",t),null)}appendCustomParams(e,t){for(let[r,n]of Object.entries(y({},e)))t=t.append(r,n.toString());return t}overWriteParam(e,t,r){return e.set(t,r)}createHttpParams(e){return e=e??"",new Ie({fromString:e,encoder:new ze})}isAuth0Endpoint(e){let{authority:t,useCustomAuth0Domain:r}=e;return t?t.endsWith(yr)||!!r:!1}composeAuth0Endpoint(e){let{authority:t,clientId:r}=e,n=this.getPostLogoutRedirectUrl(e);return`${t}/v2/logout?client_id=${r}&returnTo=${n}`}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),br=(()=>{let s=class s{constructor(){this.http=a(It)}get(e,t){return this.http.get(e,t)}post(e,t,r){return this.http.post(e,t,r)}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),Rr="ngsw-bypass",q=(()=>{let s=class s{constructor(){this.httpClient=a(br)}get(e,t,r){let n=this.prepareHeaders(r),o=this.prepareParams(t);return this.httpClient.get(e,{headers:n,params:o})}post(e,t,r,n){let o=n||this.prepareHeaders(),c=this.prepareParams(r);return this.httpClient.post(e??"",t,{headers:o,params:c})}prepareHeaders(e){let t=new _;return t=t.set("Accept","application/json"),e&&(t=t.set("Authorization","Bearer "+decodeURIComponent(e))),t}prepareParams(e){let t=new Ie,{ngswBypass:r}=e;return r&&(t=t.set(Rr,"")),t}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),Kt=i=>!!i&&i instanceof kt&&(i.error instanceof ProgressEvent&&i.error.type==="error"||i.status===0&&!!i.error),Dr=(()=>{let s=class s{constructor(){this.urlService=a(O),this.loggerService=a(S),this.tokenValidationService=a(Ae),this.flowsDataService=a(F),this.storagePersistenceService=a(E),this.dataService=a(q)}codeFlowCallback(e,t){let r=this.urlService.getUrlParameter(e,"code"),n=this.urlService.getUrlParameter(e,"state"),o=this.urlService.getUrlParameter(e,"session_state");return n?r?(this.loggerService.logDebug(t,"running validation for callback",e),g({code:r,refreshToken:"",state:n,sessionState:o,authResult:null,isRenewProcess:!1,jwtKeys:null,validationResult:null,existingIdToken:null})):(this.loggerService.logDebug(t,"no code in url"),p(()=>new Error("no code in url"))):(this.loggerService.logDebug(t,"no state in url"),p(()=>new Error("no state in url")))}codeFlowCodeRequest(e,t){let r=this.flowsDataService.getAuthStateControl(t);if(!this.tokenValidationService.validateStateFromHashCallback(e.state,r,t))return p(()=>new Error("codeFlowCodeRequest incorrect state"));let c=this.storagePersistenceService.read("authWellKnownEndPoints",t)?.tokenEndpoint;if(!c)return p(()=>new Error("Token Endpoint not defined"));let l=new _;l=l.set("Content-Type","application/x-www-form-urlencoded");let u=this.urlService.createBodyForCodeFlowCodeRequest(e.code,t,t?.customParamsCodeRequest);return this.dataService.post(c,u,t,l).pipe(D(h=>{if(h){let v=de(y({},h),{state:e.state,session_state:e.sessionState});e.authResult=v}return g(e)}),we(h=>this.handleRefreshRetry(h,t)),C(h=>{let{authority:v}=t,k=`OidcService code request ${v}`;return this.loggerService.logError(t,k,h),p(()=>new Error(k))}))}handleRefreshRetry(e,t){return e.pipe(N(r=>{if(Kt(r)){let{authority:n,refreshTokenRetryInSeconds:o}=t,c=`OidcService code request ${n} - no internet connection`;return this.loggerService.logWarning(t,c,r),ve((o??0)*1e3)}return p(()=>r)}))}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),R=function(i){return i.NotSet="NotSet",i.StatesDoNotMatch="StatesDoNotMatch",i.SignatureFailed="SignatureFailed",i.IncorrectNonce="IncorrectNonce",i.RequiredPropertyMissing="RequiredPropertyMissing",i.MaxOffsetExpired="MaxOffsetExpired",i.IssDoesNotMatchIssuer="IssDoesNotMatchIssuer",i.NoAuthWellKnownEndPoints="NoAuthWellKnownEndPoints",i.IncorrectAud="IncorrectAud",i.IncorrectIdTokenClaimsAfterRefresh="IncorrectIdTokenClaimsAfterRefresh",i.IncorrectAzp="IncorrectAzp",i.TokenExpired="TokenExpired",i.IncorrectAtHash="IncorrectAtHash",i.Ok="Ok",i.LoginRequired="LoginRequired",i.SecureTokenServerError="SecureTokenServerError",i}(R||{}),Ar={userData:null,allUserData:[]},te=(()=>{let s=class s{constructor(){this.userDataInternal$=new fe(Ar),this.loggerService=a(S),this.tokenHelperService=a(De),this.flowHelper=a($),this.oidcDataService=a(q),this.storagePersistenceService=a(E),this.eventService=a(B)}get userData$(){return this.userDataInternal$.asObservable()}getAndPersistUserDataInStore(e,t,r=!1,n,o){n=n||this.storagePersistenceService.getIdToken(e),o=o||this.tokenHelperService.getPayloadFromToken(n,!1,e);let c=this.getUserDataFromStore(e),l=!!c,u=this.flowHelper.isCurrentFlowImplicitFlowWithAccessToken(e),h=this.flowHelper.isCurrentFlowCodeFlow(e),v=this.storagePersistenceService.getAccessToken(e);if(!(u||h))return this.loggerService.logDebug(e,`authCallback idToken flow with accessToken ${v}`),this.setUserDataToStore(o,e,t),g(o);let{renewUserInfoAfterTokenRenew:k}=e;return!r||k||!l?this.getUserDataOidcFlowAndSave(o.sub,e,t).pipe(D(A=>(this.loggerService.logDebug(e,"Received user data: ",A),A?(this.loggerService.logDebug(e,"accessToken: ",v),g(A)):p(()=>new Error("Received no user data, request failed"))))):g(c)}getUserDataFromStore(e){return e?this.storagePersistenceService.read("userData",e)||null:p(()=>new Error("Please provide a configuration before setting up the module"))}publishUserDataIfExists(e,t){let r=this.getUserDataFromStore(e);r&&this.fireUserDataEvent(e,t,r)}setUserDataToStore(e,t,r){this.storagePersistenceService.write("userData",e,t),this.fireUserDataEvent(t,r,e)}resetUserDataInStore(e,t){this.storagePersistenceService.remove("userData",e),this.fireUserDataEvent(e,t,null)}getUserDataOidcFlowAndSave(e,t,r){return this.getIdentityUserData(t).pipe(m(n=>this.validateUserDataSubIdToken(t,e,n?.sub)?(this.setUserDataToStore(n,t,r),n):(this.loggerService.logWarning(t,"User data sub does not match sub in id_token, resetting"),this.resetUserDataInStore(t,r),null)))}getIdentityUserData(e){let t=this.storagePersistenceService.getAccessToken(e),r=this.storagePersistenceService.read("authWellKnownEndPoints",e);if(!r)return this.loggerService.logWarning(e,"init check session: authWellKnownEndpoints is undefined"),p(()=>new Error("authWellKnownEndpoints is undefined"));let n=r.userInfoEndpoint;return n?this.oidcDataService.get(n,e,t).pipe(Q(2)):(this.loggerService.logError(e,"init check session: authWellKnownEndpoints.userinfo_endpoint is undefined; set auto_userinfo = false in config"),p(()=>new Error("authWellKnownEndpoints.userinfo_endpoint is undefined")))}validateUserDataSubIdToken(e,t,r){return!t||!r?!1:t.toString()!==r.toString()?(this.loggerService.logDebug(e,"validateUserDataSubIdToken failed",t,r),!1):!0}fireUserDataEvent(e,t,r){let n=this.composeSingleOrMultipleUserDataObject(e,t,r);this.userDataInternal$.next(n);let{configId:o}=e;this.eventService.fireEvent(P.UserDataChanged,{configId:o,userData:r})}composeSingleOrMultipleUserDataObject(e,t,r){if(!(t.length>1)){let{configId:c}=e;return this.composeSingleUserDataResult(c??"",r)}return{userData:null,allUserData:t.map(c=>{let l=e.configId??"",u=c.configId??"";if(this.currentConfigIsToUpdate(l,c))return{configId:u,userData:r};let h=this.storagePersistenceService.read("userData",c)||null;return{configId:u,userData:h}})}}composeSingleUserDataResult(e,t){return{userData:t,allUserData:[{configId:e,userData:t}]}}currentConfigIsToUpdate(e,t){return t.configId===e}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),H=(()=>{let s=class s{constructor(){this.loggerService=a(S),this.userService=a(te),this.flowsDataService=a(F),this.authStateService=a(W)}resetAuthorizationData(e,t){e&&(this.userService.resetUserDataInStore(e,t),this.flowsDataService.resetStorageFlowData(e),this.authStateService.setUnauthenticatedAndFireEvent(e,t),this.loggerService.logDebug(e,"Local Login information cleaned up and event fired"))}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),Er=(()=>{let s=class s{constructor(){this.loggerService=a(S),this.storagePersistenceService=a(E),this.dataService=a(q)}getSigningKeys(e){let r=this.storagePersistenceService.read("authWellKnownEndPoints",e)?.jwksUri;if(!r){let n=`getSigningKeys: authWellKnownEndpoints.jwksUri is: '${r}'`;return this.loggerService.logWarning(e,n),p(()=>new Error(n))}return this.loggerService.logDebug(e,"Getting signinkeys from ",r),this.dataService.get(r,e).pipe(Q(2),C(n=>this.handleErrorGetSigningKeys(n,e)))}handleErrorGetSigningKeys(e,t){let r="";if(e instanceof mt){let n=e.body||{},o=JSON.stringify(n),{status:c,statusText:l}=e;r=`${c||""} - ${l||""} ${o||""}`}else{let{message:n}=e;r=n||`${e}`}return this.loggerService.logError(t,r),p(()=>new Error(r))}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),xt="jwtKeys",Cr=(()=>{let s=class s{constructor(){this.loggerService=a(S),this.authStateService=a(W),this.flowsDataService=a(F),this.signInKeyDataService=a(Er),this.storagePersistenceService=a(E),this.resetAuthDataService=a(H),this.document=a(U)}callbackHistoryAndResetJwtKeys(e,t,r){let n=y({},e.authResult);if(!this.responseHasIdToken(e)){let o=this.storagePersistenceService.getIdToken(t);n=de(y({},n),{id_token:o})}if(this.storagePersistenceService.write("authnResult",n,t),t.allowUnsafeReuseRefreshToken&&e.authResult?.refresh_token&&this.storagePersistenceService.write("reusable_refresh_token",e.authResult.refresh_token,t),this.historyCleanUpTurnedOn(t)&&!e.isRenewProcess?this.resetBrowserHistory():this.loggerService.logDebug(t,"history clean up inactive"),e.authResult?.error){let o=`AuthCallback AuthResult came with error: ${e.authResult.error}`;return this.loggerService.logDebug(t,o),this.resetAuthDataService.resetAuthorizationData(t,r),this.flowsDataService.setNonce("",t),this.handleResultErrorFromCallback(e.authResult,e.isRenewProcess,t.configId),p(()=>new Error(o))}return this.loggerService.logDebug(t,`AuthResult '${JSON.stringify(e.authResult,null,2)}'.
      AuthCallback created, begin token validation`),this.signInKeyDataService.getSigningKeys(t).pipe(T(o=>this.storeSigningKeys(o,t)),C(o=>{let c=this.readSigningKeys(t);return c?(this.loggerService.logWarning(t,"Failed to retrieve signing keys, fallback to stored keys"),g(c)):p(()=>new Error(o))}),D(o=>{if(o)return e.jwtKeys=o,g(e);let c="Failed to retrieve signing key";return this.loggerService.logWarning(t,c),p(()=>new Error(c))}),C(o=>{let c=`Failed to retrieve signing key with error: ${o}`;return this.loggerService.logWarning(t,c),p(()=>new Error(c))}))}responseHasIdToken(e){return!!e?.authResult?.id_token}handleResultErrorFromCallback(e,t,r){let n=R.SecureTokenServerError;e&&typeof e=="object"&&"error"in e&&e.error==="login_required"&&(n=R.LoginRequired),this.authStateService.updateAndPublishAuthState({isAuthenticated:!1,validationResult:n,isRenewProcess:t,configId:r})}historyCleanUpTurnedOn(e){let{historyCleanupOff:t}=e;return!t}resetBrowserHistory(){this.document.defaultView?.history.replaceState({},this.document.title,this.document.defaultView.location.origin+this.document.defaultView.location.pathname)}storeSigningKeys(e,t){this.storagePersistenceService.write(xt,e,t)}readSigningKeys(e){return this.storagePersistenceService.read(xt,e)}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),Tr=(()=>{let s=class s{constructor(){this.loggerService=a(S),this.resetAuthDataService=a(H),this.flowsDataService=a(F),this.document=a(U)}implicitFlowCallback(e,t,r){let n=this.flowsDataService.isSilentRenewRunning(e);this.loggerService.logDebug(e,"BEGIN callback, no auth data"),n||this.resetAuthDataService.resetAuthorizationData(e,t),r=r||this.document.location.hash.substring(1);let c={code:"",refreshToken:"",state:"",sessionState:null,authResult:r.split("&").reduce((l,u)=>{let h=u.split("=");return l[h.shift()]=h.join("="),l},{}),isRenewProcess:n,jwtKeys:null,validationResult:null,existingIdToken:null};return g(c)}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),Pr=(()=>{let s=class s{constructor(){this.loggerService=a(S),this.authStateService=a(W),this.flowsDataService=a(F)}refreshSessionWithRefreshTokens(e){let t=this.flowsDataService.getExistingOrCreateAuthStateControl(e);this.loggerService.logDebug(e,"RefreshSession created. Adding myautostate: "+t);let r=this.authStateService.getRefreshToken(e),n=this.authStateService.getIdToken(e);if(r){let o={code:"",refreshToken:r,state:t,sessionState:null,authResult:null,isRenewProcess:!0,jwtKeys:null,validationResult:null,existingIdToken:n};return this.loggerService.logDebug(e,"found refresh code, obtaining new credentials with refresh code"),this.flowsDataService.setNonce(Ae.refreshTokenNoncePlaceholder,e),g(o)}else{let o="no refresh token found, please login";return this.loggerService.logError(e,o),p(()=>new Error(o))}}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),Fr=(()=>{let s=class s{constructor(){this.urlService=a(O),this.loggerService=a(S),this.dataService=a(q),this.storagePersistenceService=a(E)}refreshTokensRequestTokens(e,t,r){let n=new _;n=n.set("Content-Type","application/x-www-form-urlencoded");let c=this.storagePersistenceService.read("authWellKnownEndPoints",t)?.tokenEndpoint;if(!c)return p(()=>new Error("Token Endpoint not defined"));let l=this.urlService.createBodyForCodeFlowRefreshTokensRequest(e.refreshToken,t,r);return this.dataService.post(c,l,t,n).pipe(D(u=>(this.loggerService.logDebug(t,`token refresh response: ${u}`),u&&(u.state=e.state),e.authResult=u,g(e))),we(u=>this.handleRefreshRetry(u,t)),C(u=>{let{authority:h}=t,v=`OidcService code request ${h}`;return this.loggerService.logError(t,v,u),p(()=>new Error(v))}))}handleRefreshRetry(e,t){return e.pipe(N(r=>{if(Kt(r)){let{authority:n,refreshTokenRetryInSeconds:o}=t,c=`OidcService code request ${n} - no internet connection`;return this.loggerService.logWarning(t,c,r),ve((o??0)*1e3)}return p(()=>r)}))}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),Ur=(()=>{let s=class s{isStringEqualOrNonOrderedArrayEqual(e,t){return this.isNullOrUndefined(e)||this.isNullOrUndefined(t)||this.oneValueIsStringAndTheOtherIsArray(e,t)?!1:this.bothValuesAreStrings(e,t)?e===t:this.arraysHaveEqualContent(e,t)}areEqual(e,t){if(!e||!t)return!1;if(this.bothValuesAreArrays(e,t))return this.arraysStrictEqual(e,t);if(this.bothValuesAreStrings(e,t))return e===t;if(this.bothValuesAreObjects(e,t))return JSON.stringify(e).toLowerCase()===JSON.stringify(t).toLowerCase();if(this.oneValueIsStringAndTheOtherIsArray(e,t)){if(Array.isArray(e)&&this.valueIsString(t))return e[0]===t;if(Array.isArray(t)&&this.valueIsString(e))return t[0]===e}return e===t}oneValueIsStringAndTheOtherIsArray(e,t){return Array.isArray(e)&&this.valueIsString(t)||Array.isArray(t)&&this.valueIsString(e)}bothValuesAreObjects(e,t){return this.valueIsObject(e)&&this.valueIsObject(t)}bothValuesAreStrings(e,t){return this.valueIsString(e)&&this.valueIsString(t)}bothValuesAreArrays(e,t){return Array.isArray(e)&&Array.isArray(t)}valueIsString(e){return typeof e=="string"||e instanceof String}valueIsObject(e){return typeof e=="object"}arraysStrictEqual(e,t){if(e.length!==t.length)return!1;for(let r=e.length;r--;)if(e[r]!==t[r])return!1;return!0}arraysHaveEqualContent(e,t){return e.length!==t.length?!1:e.some(r=>t.includes(r))}isNullOrUndefined(e){return e==null}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),Re=class{constructor(s="",d="",e=!1,t={at_hash:""},r=R.NotSet){this.accessToken=s,this.idToken=d,this.authResponseIsValid=e,this.decodedIdToken=t,this.state=r}},Mr=(()=>{let s=class s{constructor(){this.storagePersistenceService=a(E),this.tokenValidationService=a(Ae),this.tokenHelperService=a(De),this.loggerService=a(S),this.equalityService=a(Ur),this.flowHelper=a($)}getValidatedStateResult(e,t){let r=!!e.authResult?.error;return!!!e||r?g(new Re("","",!1,{})):this.validateState(e,t)}validateState(e,t){let r=new Re,n=this.storagePersistenceService.read("authStateControl",t);if(!this.tokenValidationService.validateStateFromHashCallback(e.authResult?.state,n,t))return this.loggerService.logWarning(t,"authCallback incorrect state"),r.state=R.StatesDoNotMatch,this.handleUnsuccessfulValidation(t),g(r);let o=this.flowHelper.isCurrentFlowImplicitFlowWithAccessToken(t),c=this.flowHelper.isCurrentFlowCodeFlow(t);if((o||c)&&(r.accessToken=e.authResult?.access_token??""),t.disableIdTokenValidation)return r.state=R.Ok,r.authResponseIsValid=!0,g(r);let u=e.isRenewProcess&&!!e.refreshToken,h=!!e.authResult?.id_token;if(u&&!h)return r.state=R.Ok,r.authResponseIsValid=!0,g(r);if(h){let{clientId:v,issValidationOff:k,maxIdTokenIatOffsetAllowedInSeconds:A,disableIatOffsetValidation:w,ignoreNonceAfterRefresh:j,renewTimeBeforeTokenExpiresInSeconds:M}=t;return r.idToken=e.authResult?.id_token??"",r.decodedIdToken=this.tokenHelperService.getPayloadFromToken(r.idToken,!1,t),this.tokenValidationService.validateSignatureIdToken(r.idToken,e.jwtKeys,t).pipe(N(V=>{if(!V)return this.loggerService.logDebug(t,"authCallback Signature validation failed id_token"),r.state=R.SignatureFailed,this.handleUnsuccessfulValidation(t),g(r);let ae=this.storagePersistenceService.read("authNonce",t);if(!this.tokenValidationService.validateIdTokenNonce(r.decodedIdToken,ae,!!j,t))return this.loggerService.logWarning(t,"authCallback incorrect nonce, did you call the checkAuth() method multiple times?"),r.state=R.IncorrectNonce,this.handleUnsuccessfulValidation(t),g(r);if(!this.tokenValidationService.validateRequiredIdToken(r.decodedIdToken,t))return this.loggerService.logDebug(t,"authCallback Validation, one of the REQUIRED properties missing from id_token"),r.state=R.RequiredPropertyMissing,this.handleUnsuccessfulValidation(t),g(r);if(!u&&!this.tokenValidationService.validateIdTokenIatMaxOffset(r.decodedIdToken,A??120,!!w,t))return this.loggerService.logWarning(t,"authCallback Validation, iat rejected id_token was issued too far away from the current time"),r.state=R.MaxOffsetExpired,this.handleUnsuccessfulValidation(t),g(r);let b=this.storagePersistenceService.read("authWellKnownEndPoints",t);if(b){if(k)this.loggerService.logDebug(t,"iss validation is turned off, this is not recommended!");else if(!k&&!this.tokenValidationService.validateIdTokenIss(r.decodedIdToken,b.issuer,t))return this.loggerService.logWarning(t,"authCallback incorrect iss does not match authWellKnownEndpoints issuer"),r.state=R.IssDoesNotMatchIssuer,this.handleUnsuccessfulValidation(t),g(r)}else return this.loggerService.logWarning(t,"authWellKnownEndpoints is undefined"),r.state=R.NoAuthWellKnownEndPoints,this.handleUnsuccessfulValidation(t),g(r);return this.tokenValidationService.validateIdTokenAud(r.decodedIdToken,v,t)?this.tokenValidationService.validateIdTokenAzpExistsIfMoreThanOneAud(r.decodedIdToken)?this.tokenValidationService.validateIdTokenAzpValid(r.decodedIdToken,v)?this.isIdTokenAfterRefreshTokenRequestValid(e,r.decodedIdToken,t)?!u&&!this.tokenValidationService.validateIdTokenExpNotExpired(r.decodedIdToken,t,M)?(this.loggerService.logWarning(t,"authCallback id token expired"),r.state=R.TokenExpired,this.handleUnsuccessfulValidation(t),g(r)):this.validateDefault(o,c,r,t,e):(this.loggerService.logWarning(t,"authCallback pre, post id_token claims do not match in refresh"),r.state=R.IncorrectIdTokenClaimsAfterRefresh,this.handleUnsuccessfulValidation(t),g(r)):(this.loggerService.logWarning(t,"authCallback incorrect azp"),r.state=R.IncorrectAzp,this.handleUnsuccessfulValidation(t),g(r)):(this.loggerService.logWarning(t,"authCallback missing azp"),r.state=R.IncorrectAzp,this.handleUnsuccessfulValidation(t),g(r)):(this.loggerService.logWarning(t,"authCallback incorrect aud"),r.state=R.IncorrectAud,this.handleUnsuccessfulValidation(t),g(r))}))}else this.loggerService.logDebug(t,"No id_token found, skipping id_token validation");return this.validateDefault(o,c,r,t,e)}validateDefault(e,t,r,n,o){if(!e&&!t)return r.authResponseIsValid=!0,r.state=R.Ok,this.handleSuccessfulValidation(n),this.handleUnsuccessfulValidation(n),g(r);if(o.authResult?.id_token){let c=this.tokenHelperService.getHeaderFromToken(r.idToken,!1,n);if(t&&!r.decodedIdToken.at_hash)this.loggerService.logDebug(n,"Code Flow active, and no at_hash in the id_token, skipping check!");else return this.tokenValidationService.validateIdTokenAtHash(r.accessToken,r.decodedIdToken.at_hash,c.alg,n).pipe(m(l=>!l||!r.accessToken?(this.loggerService.logWarning(n,"authCallback incorrect at_hash"),r.state=R.IncorrectAtHash,this.handleUnsuccessfulValidation(n),r):(r.authResponseIsValid=!0,r.state=R.Ok,this.handleSuccessfulValidation(n),r)))}return r.authResponseIsValid=!0,r.state=R.Ok,this.handleSuccessfulValidation(n),g(r)}isIdTokenAfterRefreshTokenRequestValid(e,t,r){let{useRefreshToken:n,disableRefreshIdTokenAuthTimeValidation:o}=r;if(!n||!e.existingIdToken)return!0;let c=this.tokenHelperService.getPayloadFromToken(e.existingIdToken,!1,r);return c.iss!==t.iss?(this.loggerService.logDebug(r,`iss do not match: ${c.iss} ${t.iss}`),!1):c.azp!==t.azp?(this.loggerService.logDebug(r,`azp do not match: ${c.azp} ${t.azp}`),!1):c.sub!==t.sub?(this.loggerService.logDebug(r,`sub do not match: ${c.sub} ${t.sub}`),!1):this.equalityService.isStringEqualOrNonOrderedArrayEqual(c?.aud,t?.aud)?o?!0:c.auth_time!==t.auth_time?(this.loggerService.logDebug(r,`auth_time do not match: ${c.auth_time} ${t.auth_time}`),!1):!0:(this.loggerService.logDebug(r,`aud in new id_token is not valid: '${c?.aud}' '${t.aud}'`),!1)}handleSuccessfulValidation(e){let{autoCleanStateAfterAuthentication:t}=e;this.storagePersistenceService.write("authNonce",null,e),t&&this.storagePersistenceService.write("authStateControl","",e),this.loggerService.logDebug(e,"authCallback token(s) validated, continue")}handleUnsuccessfulValidation(e){let{autoCleanStateAfterAuthentication:t}=e;this.storagePersistenceService.write("authNonce",null,e),t&&this.storagePersistenceService.write("authStateControl","",e),this.loggerService.logDebug(e,"authCallback token(s) invalid")}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),Wr=(()=>{let s=class s{constructor(){this.loggerService=a(S),this.stateValidationService=a(Mr),this.authStateService=a(W),this.resetAuthDataService=a(H),this.document=a(U)}callbackStateValidation(e,t,r){return this.stateValidationService.getValidatedStateResult(e,t).pipe(m(n=>{if(e.validationResult=n,n.authResponseIsValid)return this.authStateService.setAuthorizationData(n.accessToken,e.authResult,t,r),e;{let o=`authorizedCallback, token(s) validation failed, resetting. Hash: ${this.document.location.hash}`;throw this.loggerService.logWarning(t,o),this.resetAuthDataService.resetAuthorizationData(t,r),this.publishUnauthorizedState(e.validationResult,e.isRenewProcess,t.configId),new Error(o)}}))}publishUnauthorizedState(e,t,r){this.authStateService.updateAndPublishAuthState({isAuthenticated:!1,validationResult:e.state,isRenewProcess:t,configId:r})}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),xr=(()=>{let s=class s{constructor(){this.loggerService=a(S),this.authStateService=a(W),this.flowsDataService=a(F),this.userService=a(te),this.resetAuthDataService=a(H)}callbackUser(e,t,r){let{isRenewProcess:n,validationResult:o,authResult:c,refreshToken:l}=e,{autoUserInfo:u,renewUserInfoAfterTokenRenew:h}=t;return u?this.userService.getAndPersistUserDataInStore(t,r,n,o?.idToken,o?.decodedIdToken).pipe(D(v=>{if(v)return l||this.flowsDataService.setSessionState(c?.session_state,t),this.publishAuthState(o,n,t.configId),g(e);{this.resetAuthDataService.resetAuthorizationData(t,r),this.publishUnauthenticatedState(o,n,t.configId);let k=`Called for userData but they were ${v}`;return this.loggerService.logWarning(t,k),p(()=>new Error(k))}}),C(v=>{let k=`Failed to retrieve user info with error:  ${v}`;return this.loggerService.logWarning(t,k),p(()=>new Error(k))})):((!n||h)&&o?.decodedIdToken&&this.userService.setUserDataToStore(o.decodedIdToken,t,r),!n&&!l&&this.flowsDataService.setSessionState(c?.session_state,t),this.publishAuthState(o,n,t.configId),g(e))}publishAuthState(e,t,r){e&&this.authStateService.updateAndPublishAuthState({isAuthenticated:!0,validationResult:e.state,isRenewProcess:t,configId:r})}publishUnauthenticatedState(e,t,r){e&&this.authStateService.updateAndPublishAuthState({isAuthenticated:!1,validationResult:e.state,isRenewProcess:t,configId:r})}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),Ee=(()=>{let s=class s{constructor(){this.codeFlowCallbackHandlerService=a(Dr),this.implicitFlowCallbackHandlerService=a(Tr),this.historyJwtKeysCallbackHandlerService=a(Cr),this.userHandlerService=a(xr),this.stateValidationCallbackHandlerService=a(Wr),this.refreshSessionCallbackHandlerService=a(Pr),this.refreshTokenCallbackHandlerService=a(Fr)}processCodeFlowCallback(e,t,r){return this.codeFlowCallbackHandlerService.codeFlowCallback(e,t).pipe(I(n=>this.codeFlowCallbackHandlerService.codeFlowCodeRequest(n,t)),I(n=>this.historyJwtKeysCallbackHandlerService.callbackHistoryAndResetJwtKeys(n,t,r)),I(n=>this.stateValidationCallbackHandlerService.callbackStateValidation(n,t,r)),I(n=>this.userHandlerService.callbackUser(n,t,r)))}processSilentRenewCodeFlowCallback(e,t,r){return this.codeFlowCallbackHandlerService.codeFlowCodeRequest(e,t).pipe(I(n=>this.historyJwtKeysCallbackHandlerService.callbackHistoryAndResetJwtKeys(n,t,r)),I(n=>this.stateValidationCallbackHandlerService.callbackStateValidation(n,t,r)),I(n=>this.userHandlerService.callbackUser(n,t,r)))}processImplicitFlowCallback(e,t,r){return this.implicitFlowCallbackHandlerService.implicitFlowCallback(e,t,r).pipe(I(n=>this.historyJwtKeysCallbackHandlerService.callbackHistoryAndResetJwtKeys(n,e,t)),I(n=>this.stateValidationCallbackHandlerService.callbackStateValidation(n,e,t)),I(n=>this.userHandlerService.callbackUser(n,e,t)))}processRefreshToken(e,t,r){return this.refreshSessionCallbackHandlerService.refreshSessionWithRefreshTokens(e).pipe(I(n=>this.refreshTokenCallbackHandlerService.refreshTokensRequestTokens(n,e,r)),I(n=>this.historyJwtKeysCallbackHandlerService.callbackHistoryAndResetJwtKeys(n,e,t)),I(n=>this.stateValidationCallbackHandlerService.callbackStateValidation(n,e,t)),I(n=>this.userHandlerService.callbackUser(n,e,t)))}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),he=(()=>{let s=class s{constructor(){this.runTokenValidationRunning=null,this.zone=a(xe),this.document=a(U)}isTokenValidationRunning(){return!!this.runTokenValidationRunning}stopPeriodicTokenCheck(){this.runTokenValidationRunning&&(this.runTokenValidationRunning.unsubscribe(),this.runTokenValidationRunning=null)}startPeriodicTokenCheck(e){let t=e*1e3;return new ce(r=>{let n;return this.zone.runOutsideAngular(()=>{n=this.document?.defaultView?.setInterval(()=>this.zone.run(()=>r.next()),t)}),()=>{clearInterval(n)}})}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),Or=(()=>{let s=class s{constructor(){this.flowsService=a(Ee),this.router=a(ee),this.flowsDataService=a(F),this.intervalService=a(he)}authenticatedCallbackWithCode(e,t,r){let n=this.flowsDataService.isSilentRenewRunning(t),{triggerAuthorizationResultEvent:o}=t,c=t.postLoginRoute||"/",l=t.unauthorizedRoute||"/";return this.flowsService.processCodeFlowCallback(e,t,r).pipe(T(u=>{this.flowsDataService.resetCodeFlowInProgress(t),!o&&!u.isRenewProcess&&this.router.navigateByUrl(c)}),C(u=>(this.flowsDataService.resetSilentRenewRunning(t),this.flowsDataService.resetCodeFlowInProgress(t),this.intervalService.stopPeriodicTokenCheck(),!o&&!n&&this.router.navigateByUrl(l),p(()=>new Error(u)))))}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),Lt=(()=>{let s=class s{constructor(){this.flowsService=a(Ee),this.router=a(ee),this.flowsDataService=a(F),this.intervalService=a(he)}authenticatedImplicitFlowCallback(e,t,r){let n=this.flowsDataService.isSilentRenewRunning(e),o=!!e.triggerAuthorizationResultEvent,c=e.postLoginRoute??"",l=e.unauthorizedRoute??"";return this.flowsService.processImplicitFlowCallback(e,t,r).pipe(T(u=>{!o&&!u.isRenewProcess&&this.router.navigateByUrl(c)}),C(u=>(this.flowsDataService.resetSilentRenewRunning(e),this.intervalService.stopPeriodicTokenCheck(),!o&&!n&&this.router.navigateByUrl(l),p(()=>new Error(u)))))}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),zt=(()=>{let s=class s{constructor(){this.urlService=a(O),this.flowHelper=a($),this.implicitFlowCallbackService=a(Lt),this.codeFlowCallbackService=a(Or),this.stsCallbackInternal$=new ge}get stsCallback$(){return this.stsCallbackInternal$.asObservable()}isCallback(e,t){return e?this.urlService.isCallbackFromSts(e,t):!1}handleCallbackAndFireEvents(e,t,r){let n=new ce;if(this.flowHelper.isCurrentFlowCodeFlow(t))n=this.codeFlowCallbackService.authenticatedCallbackWithCode(e,t,r);else if(this.flowHelper.isCurrentFlowAnyImplicitFlow(t))if(e?.includes("#")){let o=e.substring(e.indexOf("#")+1);n=this.implicitFlowCallbackService.authenticatedImplicitFlowCallback(t,r,o)}else n=this.implicitFlowCallbackService.authenticatedImplicitFlowCallback(t,r);return n.pipe(T(()=>this.stsCallbackInternal$.next()))}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),$r=(()=>{let s=class s{constructor(){this.platformId=a(ct)}isBrowser(){return St(this.platformId)}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),Ot="/.well-known/openid-configuration",Hr=(()=>{let s=class s{constructor(){this.loggerService=a(S),this.http=a(q)}getWellKnownEndPointsForConfig(e){let{authWellknownEndpointUrl:t,authWellknownEndpoints:r={}}=e;if(!t){let n="no authWellknownEndpoint given!";return this.loggerService.logError(e,n),p(()=>new Error(n))}return this.getWellKnownDocument(t,e).pipe(m(n=>({issuer:n.issuer,jwksUri:n.jwks_uri,authorizationEndpoint:n.authorization_endpoint,tokenEndpoint:n.token_endpoint,userInfoEndpoint:n.userinfo_endpoint,endSessionEndpoint:n.end_session_endpoint,checkSessionIframe:n.check_session_iframe,revocationEndpoint:n.revocation_endpoint,introspectionEndpoint:n.introspection_endpoint,parEndpoint:n.pushed_authorization_request_endpoint})),m(n=>y(y({},n),r)),T(n=>{let o=n.issuer||"",c=e.authWellknownUrlSuffix||Ot,l=t.replace(c,"");if(o!==l&&o!==`${l}/`){let u=`Issuer mismatch. Well known issuer ${n.issuer} does not match configured well known url ${t}`;throw this.loggerService.logError(e,u),new Error(u)}}))}getWellKnownDocument(e,t){let r=e,n=t.authWellknownUrlSuffix||Ot;return e.includes(n)||(r=`${e}${n}`),this.http.get(r,t).pipe(Q(2))}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),re=(()=>{let s=class s{constructor(){this.dataService=a(Hr),this.publicEventsService=a(B),this.storagePersistenceService=a(E)}storeWellKnownEndpoints(e,t){this.storagePersistenceService.write("authWellKnownEndPoints",t,e)}queryAndStoreAuthWellKnownEndPoints(e){return e?this.dataService.getWellKnownEndPointsForConfig(e).pipe(T(t=>this.storeWellKnownEndpoints(e,t)),C(t=>(this.publicEventsService.fireEvent(P.ConfigLoadingFailed,null),p(()=>new Error(t))))):p(()=>new Error("Please provide a configuration before setting up the module"))}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),jr={authority:"https://please_set",authWellknownEndpointUrl:"",authWellknownEndpoints:void 0,redirectUrl:"https://please_set",checkRedirectUrlWhenCheckingIfIsCallback:!0,clientId:"please_set",responseType:"code",scope:"openid email profile",hdParam:"",postLogoutRedirectUri:"https://please_set",startCheckSession:!1,silentRenew:!1,silentRenewUrl:"https://please_set",silentRenewTimeoutInSeconds:20,renewTimeBeforeTokenExpiresInSeconds:0,useRefreshToken:!1,usePushedAuthorisationRequests:!1,ignoreNonceAfterRefresh:!1,postLoginRoute:"/",forbiddenRoute:"/forbidden",unauthorizedRoute:"/unauthorized",autoUserInfo:!0,autoCleanStateAfterAuthentication:!0,triggerAuthorizationResultEvent:!1,logLevel:z.Warn,issValidationOff:!1,historyCleanupOff:!1,maxIdTokenIatOffsetAllowedInSeconds:120,disableIatOffsetValidation:!1,customParamsAuthRequest:{},customParamsRefreshTokenRequest:{},customParamsEndSessionRequest:{},customParamsCodeRequest:{},disableRefreshIdTokenAuthTimeValidation:!1,triggerRefreshWhenIdTokenExpired:!0,tokenRefreshInSeconds:4,refreshTokenRetryInSeconds:3,ngswBypass:!1},se={result:!0,messages:[],level:"none"},Vr=i=>i.authority?se:{result:!1,messages:["The authority URL MUST be provided in the configuration! "],level:"error"},Nr=i=>i.clientId?se:{result:!1,messages:["The clientId is required and missing from your config!"],level:"error"},Kr=i=>{if(!i)return"";let{authority:s,clientId:d,scope:e}=i;return`${s}${d}${e}`},Lr=i=>new Set(i).size!==i.length,zr=i=>{let s=i.map(t=>Kr(t));return s.some(t=>t==="")?{result:!1,messages:["Please make sure you add an object with a 'config' property: ....({ config }) instead of ...(config)"],level:"error"}:Lr(s)?{result:!1,messages:["You added multiple configs with the same authority, clientId and scope"],level:"warning"}:se},Br=i=>i.redirectUrl?se:{result:!1,messages:["The redirectUrl is required and missing from your config"],level:"error"},qr=i=>{let s=i.silentRenew,d=i.useRefreshToken,e=i.silentRenewUrl;return s&&!d&&!e?{result:!1,messages:["Please provide a silent renew URL if using renew and not refresh tokens"],level:"error"}:se},Jr=i=>{let s=i.useRefreshToken,d=i.silentRenew,t=(i.scope||"").split(" ").includes("offline_access");return s&&d&&!t?{result:!1,messages:["When using silent renew and refresh tokens please set the `offline_access` scope"],level:"warning"}:se},Gr=[Vr,Jr,Br,Nr,qr],Qr=[zr],Xr=(()=>{let s=class s{constructor(){this.loggerService=a(S)}validateConfigs(e){return this.validateConfigsInternal(e??[],Qr)}validateConfig(e){return this.validateConfigInternal(e,Gr)}validateConfigsInternal(e,t){if(e.length===0)return!1;let r=t.map(o=>o(e)),n=0;return e.forEach(o=>{let c=this.processValidationResultsAndGetErrorCount(r,o);n+=c}),n===0}validateConfigInternal(e,t){let r=t.map(o=>o(e));return this.processValidationResultsAndGetErrorCount(r,e)===0}processValidationResultsAndGetErrorCount(e,t){let r=e.filter(c=>c.messages.length>0),n=this.getAllMessagesOfType("error",r),o=this.getAllMessagesOfType("warning",r);return n.forEach(c=>this.loggerService.logError(t,c)),o.forEach(c=>this.loggerService.logWarning(t,c)),n.length}getAllMessagesOfType(e,t){return t.filter(n=>n.level===e).map(n=>n.messages).reduce((n,o)=>n.concat(o),[])}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),Ge=(()=>{let s=class s{constructor(){this.configsInternal={},this.loggerService=a(S),this.publicEventsService=a(B),this.storagePersistenceService=a(E),this.platformProvider=a($r),this.authWellKnownService=a(re),this.loader=a(be),this.configValidationService=a(Xr)}hasManyConfigs(){return Object.keys(this.configsInternal).length>1}getAllConfigurations(){return Object.values(this.configsInternal)}getOpenIDConfiguration(e){return this.configsAlreadySaved()?g(this.getConfig(e)):this.getOpenIDConfigurations(e).pipe(m(t=>t.currentConfig))}getOpenIDConfigurations(e){return this.loadConfigs().pipe(I(t=>this.prepareAndSaveConfigs(t)),m(t=>({allConfigs:t,currentConfig:this.getConfig(e)})))}hasAtLeastOneConfig(){return Object.keys(this.configsInternal).length>0}saveConfig(e){let{configId:t}=e;this.configsInternal[t]=e}loadConfigs(){return this.loader.loadConfigs()}configsAlreadySaved(){return this.hasAtLeastOneConfig()}getConfig(e){if(e){let r=this.configsInternal[e];return!r&&pt()&&console.warn(`[angular-auth-oidc-client] No configuration found for config id '${e}'.`),r||null}let[,t]=Object.entries(this.configsInternal)[0]||[[null,null]];return t||null}prepareAndSaveConfigs(e){if(!this.configValidationService.validateConfigs(e))return g([]);this.createUniqueIds(e);let t=e.map(r=>this.handleConfig(r));return G(t).pipe(m(r=>r.filter(n=>!!n)),m(r=>r))}createUniqueIds(e){e.forEach((t,r)=>{t.configId||(t.configId=`${r}-${t.clientId}`)})}handleConfig(e){if(!this.configValidationService.validateConfig(e))return this.loggerService.logError(e,"Validation of config rejected with errors. Config is NOT set."),g(null);e.authWellknownEndpointUrl||(e.authWellknownEndpointUrl=e.authority);let t=this.prepareConfig(e);this.saveConfig(t);let r=this.enhanceConfigWithWellKnownEndpoint(t);return this.publicEventsService.fireEvent(P.ConfigLoaded,r),g(t)}enhanceConfigWithWellKnownEndpoint(e){let t=this.storagePersistenceService.read("authWellKnownEndPoints",e);if(t)return e.authWellknownEndpoints=t,e;let r=e.authWellknownEndpoints;return r&&(this.authWellKnownService.storeWellKnownEndpoints(e,r),e.authWellknownEndpoints=r),e}prepareConfig(e){let t=y(y({},jr),e);return this.setSpecialCases(t),t}setSpecialCases(e){this.platformProvider.isBrowser()||(e.startCheckSession=!1,e.silentRenew=!1,e.useRefreshToken=!1,e.usePushedAuthorisationRequests=!1)}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),Bt=(()=>{let s=class s{constructor(){this.document=a(U),this.loggerService=a(S)}getExistingIFrame(e){let t=this.getIFrameFromParentWindow(e);if(this.isIFrameElement(t))return t;let r=this.getIFrameFromWindow(e);return this.isIFrameElement(r)?r:null}addIFrameToWindowBody(e,t){let r=this.document.createElement("iframe");return r.id=e,r.title=e,this.loggerService.logDebug(t,r),r.style.display="none",this.document.body.appendChild(r),r}getIFrameFromParentWindow(e){try{let t=this.document.defaultView?.parent.document.getElementById(e);return this.isIFrameElement(t)?t:null}catch{return null}}getIFrameFromWindow(e){let t=this.document.getElementById(e);return this.isIFrameElement(t)?t:null}isIFrameElement(e){return!!e&&e instanceof HTMLIFrameElement}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),Yr="myiFrameForSilentRenew",qt=i=>`${Yr}_${i}`,Qe=(()=>{let s=class s{constructor(){this.refreshSessionWithIFrameCompletedInternal$=new ge,this.loggerService=a(S),this.iFrameService=a(Bt),this.flowsService=a(Ee),this.resetAuthDataService=a(H),this.flowsDataService=a(F),this.authStateService=a(W),this.flowHelper=a($),this.implicitFlowCallbackService=a(Lt),this.intervalService=a(he)}get refreshSessionWithIFrameCompleted$(){return this.refreshSessionWithIFrameCompletedInternal$.asObservable()}getOrCreateIframe(e){let t=qt(e.configId),r=this.iFrameService.getExistingIFrame(t);return r?(this.loggerService.logDebug(e,`Using existing iframe: ${t}`),r):(this.loggerService.logDebug(e,`Creating new iframe: ${t}`),this.iFrameService.addIFrameToWindowBody(t,e))}isSilentRenewConfigured(e){let{useRefreshToken:t,silentRenew:r}=e;return!t&&!!r}codeFlowCallbackSilentRenewIframe(e,t,r){let n=new Ie({fromString:e[1]}),o=n.get("error");if(o)return this.authStateService.updateAndPublishAuthState({isAuthenticated:!1,validationResult:R.LoginRequired,isRenewProcess:!0,configId:t.configId}),this.resetAuthDataService.resetAuthorizationData(t,r),this.flowsDataService.setNonce("",t),this.intervalService.stopPeriodicTokenCheck(),p(()=>new Error(o));let c=n.get("code")??"",l=n.get("state")??"",u=n.get("session_state"),h={code:c,refreshToken:"",state:l,sessionState:u,authResult:null,isRenewProcess:!0,jwtKeys:null,validationResult:null,existingIdToken:null};return this.flowsService.processSilentRenewCodeFlowCallback(h,t,r).pipe(C(v=>(this.intervalService.stopPeriodicTokenCheck(),this.resetAuthDataService.resetAuthorizationData(t,r),p(()=>new Error(v)))))}silentRenewEventHandler(e,t,r){if(this.loggerService.logDebug(t,"silentRenewEventHandler"),!e.detail)return;let n;if(this.flowHelper.isCurrentFlowCodeFlow(t)){let c=e.detail.toString().split("?");n=this.codeFlowCallbackSilentRenewIframe(c,t,r)}else n=this.implicitFlowCallbackService.authenticatedImplicitFlowCallback(t,r,e.detail);n.subscribe({next:({authResult:c})=>{this.refreshSessionWithIFrameCompletedInternal$.next({authResult:c,configId:t.configId,success:!0}),this.flowsDataService.resetSilentRenewRunning(t)},error:c=>{this.loggerService.logError(t,"Error: "+c),this.refreshSessionWithIFrameCompletedInternal$.next({configId:t.configId,success:!1}),this.flowsDataService.resetSilentRenewRunning(t)}})}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),Jt=(()=>{let s=class s{constructor(){this.renderer=a(lt).createRenderer(null,null),this.loggerService=a(S),this.urlService=a(O),this.silentRenewService=a(Qe),this.document=a(U)}refreshSessionWithIframe(e,t,r){return this.loggerService.logDebug(e,"BEGIN refresh session Authorize Iframe renew"),this.urlService.getRefreshSessionSilentRenewUrl(e,r).pipe(D(n=>this.sendAuthorizeRequestUsingSilentRenew(n,e,t)))}sendAuthorizeRequestUsingSilentRenew(e,t,r){let n=this.silentRenewService.getOrCreateIframe(t);return this.initSilentRenewRequest(t,r),this.loggerService.logDebug(t,`sendAuthorizeRequestUsingSilentRenew for URL: ${e}`),new ce(o=>{let c=()=>{n.removeEventListener("load",c),this.loggerService.logDebug(t,"removed event listener from IFrame"),o.next(!0),o.complete()};n.addEventListener("load",c),n.contentWindow?.location.replace(e??"")})}initSilentRenewRequest(e,t){let r=Math.random();this.loggerService.logDebug(e,`Creating new silent renew handlers for config: ${e.configId}, instance: ${r}`);let n=this.renderer.listen("window","oidc-silent-renew-init",c=>{let l=c.detail;l.configId===e.configId&&l.instanceId!==r&&(this.loggerService.logDebug(e,`Destroying old handlers for config: ${e.configId} (old instance: ${r}, new instance: ${l.instanceId})`),n(),o())}),o=this.renderer.listen("window","oidc-silent-renew-message",c=>{if(this.shouldProcessRenewMessage(c,e)){let l=this.convertToLegacyEvent(c);this.silentRenewService.silentRenewEventHandler(l,e,t)}});this.document.defaultView?.dispatchEvent(new CustomEvent("oidc-silent-renew-init",{detail:{instanceId:r,configId:e.configId}}))}shouldProcessRenewMessage(e,t){if(!e?.detail)return this.loggerService.logDebug(t,`Silent renew event has no valid payload: ${e?.detail}`),!1;if(e.detail.srcFrameId){let r=qt(t.configId)===e.detail.srcFrameId;return this.loggerService.logDebug(t,`Silent renew event from frame: ${e.detail.srcFrameId}, current configId: ${t.configId}, processing: ${r}`),r}return this.loggerService.logDebug(t,"Silent renew event without srcFrameId - processing for backward compatibility"),!0}convertToLegacyEvent(e){return e?.detail?.url?new CustomEvent(e.type,{detail:e.detail.url}):e}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),Gt=(()=>{let s=class s{constructor(){this.loggerService=a(S),this.resetAuthDataService=a(H),this.flowsService=a(Ee),this.intervalService=a(he)}refreshSessionWithRefreshTokens(e,t,r){this.loggerService.logDebug(e,"BEGIN refresh session Authorize");let n=!1;return this.flowsService.processRefreshToken(e,t,r).pipe(C(o=>(this.resetAuthDataService.resetAuthorizationData(e,t),n=!0,p(()=>new Error(o)))),Se(()=>n&&this.intervalService.stopPeriodicTokenCheck()))}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),Zr=(()=>{let s=class s{constructor(){this.resetAuthDataService=a(H),this.flowHelper=a($),this.flowsDataService=a(F),this.loggerService=a(S),this.userService=a(te),this.authStateService=a(W),this.refreshSessionIframeService=a(Jt),this.refreshSessionRefreshTokenService=a(Gt),this.intervalService=a(he),this.storagePersistenceService=a(E),this.publicEventsService=a(B),this.configurationService=a(Ge)}startTokenValidationPeriodically(e,t){let r=this.getConfigsWithSilentRenewEnabled(e);if(r.length<=0||this.intervalService.isTokenValidationRunning())return;let n=this.getSmallestRefreshTimeFromConfigs(r),o=this.intervalService.startPeriodicTokenCheck(n).pipe(D(()=>{let c={};return r.forEach(l=>{let u=l.configId;c[u]=this.getRefreshEvent(l,e)}),G(c)}));this.intervalService.runTokenValidationRunning=o.pipe(C(c=>p(()=>new Error(c)))).subscribe({next:c=>{for(let[l,u]of Object.entries(c))this.configurationService.getOpenIDConfiguration(l).subscribe(h=>{this.loggerService.logDebug(h,"silent renew, periodic check finished!"),this.flowHelper.isCurrentFlowCodeFlowWithRefreshTokens(h)&&this.flowsDataService.resetSilentRenewRunning(h)})},error:c=>{this.loggerService.logError(t,"silent renew failed!",c)}})}getRefreshEvent(e,t){if(!this.shouldStartPeriodicallyCheckForConfig(e))return g(null);let n=this.createRefreshEventForConfig(e,t);return this.publicEventsService.fireEvent(P.SilentRenewStarted),n.pipe(C(o=>(this.loggerService.logError(e,"silent renew failed!",o),this.publicEventsService.fireEvent(P.SilentRenewFailed,o),this.flowsDataService.resetSilentRenewRunning(e),p(()=>new Error(o)))))}getSmallestRefreshTimeFromConfigs(e){return e.reduce((r,n)=>(r.tokenRefreshInSeconds??0)<(n.tokenRefreshInSeconds??0)?r:n).tokenRefreshInSeconds??0}getConfigsWithSilentRenewEnabled(e){return e.filter(t=>t.silentRenew)}createRefreshEventForConfig(e,t){return this.loggerService.logDebug(e,"starting silent renew..."),this.configurationService.getOpenIDConfiguration(e.configId).pipe(D(r=>{if(!r?.silentRenew)return this.resetAuthDataService.resetAuthorizationData(r,t),g(null);if(this.flowsDataService.setSilentRenewRunning(r),this.flowHelper.isCurrentFlowCodeFlowWithRefreshTokens(r)){let o=this.storagePersistenceService.read("storageCustomParamsRefresh",r)||{},{customParamsRefreshTokenRequest:c}=r,l=y(y({},c),o);return this.refreshSessionRefreshTokenService.refreshSessionWithRefreshTokens(r,t,l)}let n=this.storagePersistenceService.read("storageCustomParamsAuthRequest",r);return this.refreshSessionIframeService.refreshSessionWithIframe(r,t,n)}))}shouldStartPeriodicallyCheckForConfig(e){let t=this.authStateService.getIdToken(e),r=this.flowsDataService.isSilentRenewRunning(e),n=this.flowsDataService.isCodeFlowInProgress(e),o=this.userService.getUserDataFromStore(e);if(this.loggerService.logDebug(e,`Checking: silentRenewRunning: ${r}, isCodeFlowInProgress: ${n} - has idToken: ${!!t} - has userData: ${!!o}`),!(!!o&&!r&&!!t&&!n))return!1;let l=this.authStateService.hasIdTokenExpiredAndRenewCheckIsEnabled(e),u=this.authStateService.hasAccessTokenExpiredIfExpiryExists(e);return l||u}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),_r=3,Qt=(()=>{let s=class s{constructor(){this.flowHelper=a($),this.flowsDataService=a(F),this.loggerService=a(S),this.silentRenewService=a(Qe),this.authStateService=a(W),this.authWellKnownService=a(re),this.refreshSessionIframeService=a(Jt),this.storagePersistenceService=a(E),this.refreshSessionRefreshTokenService=a(Gt),this.userService=a(te)}userForceRefreshSession(e,t,r){return e?(this.persistCustomParams(r,e),this.forceRefreshSession(e,t,r).pipe(T(()=>this.flowsDataService.resetSilentRenewRunning(e)))):p(()=>new Error("Please provide a configuration before setting up the module"))}forceRefreshSession(e,t,r){let{customParamsRefreshTokenRequest:n,configId:o}=e,c=y(y({},n),r);if(this.flowHelper.isCurrentFlowCodeFlowWithRefreshTokens(e))return this.startRefreshSession(e,t,c).pipe(m(()=>{let h=this.authStateService.areAuthStorageTokensValid(e);return h?{idToken:this.authStateService.getIdToken(e),accessToken:this.authStateService.getAccessToken(e),userData:this.userService.getUserDataFromStore(e),isAuthenticated:h,configId:o}:{isAuthenticated:!1,errorMessage:"",userData:null,idToken:"",accessToken:"",configId:o}}));let{silentRenewTimeoutInSeconds:l}=e,u=(l??0)*1e3;return G([this.startRefreshSession(e,t,r),this.silentRenewService.refreshSessionWithIFrameCompleted$.pipe(it(h=>h?.configId===e.configId),le(1))]).pipe(st(u),we(h=>h.pipe(N((v,k)=>{let w=k+1;return!(v instanceof rt)||w>_r?p(()=>new Error(v)):(this.loggerService.logDebug(e,`forceRefreshSession timeout. Attempt #${w}`),this.flowsDataService.resetSilentRenewRunning(e),ve(w*1e3))}))),m(([h,v])=>{let k=this.authStateService.areAuthStorageTokensValid(e);if(k){let A=v.success?v.authResult:null;return{idToken:A?.id_token??"",accessToken:A?.access_token??"",userData:this.userService.getUserDataFromStore(e),isAuthenticated:k,configId:o}}return{isAuthenticated:!1,errorMessage:"",userData:null,idToken:"",accessToken:"",configId:o}}))}persistCustomParams(e,t){let{useRefreshToken:r}=t;e&&(r?this.storagePersistenceService.write("storageCustomParamsRefresh",e,t):this.storagePersistenceService.write("storageCustomParamsAuthRequest",e,t))}startRefreshSession(e,t,r){let n=this.flowsDataService.isSilentRenewRunning(e);return this.loggerService.logDebug(e,`Checking: silentRenewRunning: ${n}`),!n?this.authWellKnownService.queryAndStoreAuthWellKnownEndPoints(e).pipe(D(()=>(this.flowsDataService.setSilentRenewRunning(e),this.flowHelper.isCurrentFlowCodeFlowWithRefreshTokens(e)?this.refreshSessionRefreshTokenService.refreshSessionWithRefreshTokens(e,t,r):this.refreshSessionIframeService.refreshSessionWithIframe(e,t,r)))):g(null)}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),$t="myiFrameForCheckSession",Xe=(()=>{let s=class s{constructor(){this.checkSessionReceived=!1,this.scheduledHeartBeatRunning=null,this.lastIFrameRefresh=0,this.outstandingMessages=0,this.loggerService=a(S),this.storagePersistenceService=a(E),this.iFrameService=a(Bt),this.eventService=a(B),this.zone=a(xe),this.document=a(U),this.heartBeatInterval=3e3,this.iframeRefreshInterval=6e4,this.checkSessionChangedInternal$=new fe(!1)}get checkSessionChanged$(){return this.checkSessionChangedInternal$.asObservable()}ngOnDestroy(){this.stop();let e=this.document.defaultView;e&&this.iframeMessageEventListener&&e.removeEventListener("message",this.iframeMessageEventListener,!1)}isCheckSessionConfigured(e){let{startCheckSession:t}=e;return!!t}start(e){if(this.scheduledHeartBeatRunning)return;let{clientId:t}=e;this.pollServerSession(t,e)}stop(){this.scheduledHeartBeatRunning&&(this.clearScheduledHeartBeat(),this.checkSessionReceived=!1)}serverStateChanged(e){let{startCheckSession:t}=e;return!!t&&this.checkSessionReceived}getExistingIframe(){return this.iFrameService.getExistingIFrame($t)}init(e){if(this.lastIFrameRefresh+this.iframeRefreshInterval>Date.now())return g();let t=this.storagePersistenceService.read("authWellKnownEndPoints",e);if(!t)return this.loggerService.logWarning(e,"CheckSession - init check session: authWellKnownEndpoints is undefined. Returning."),g();let r=this.getOrCreateIframe(e);this.bindMessageEventToIframe(e);let n=t.checkSessionIframe,o=r.contentWindow;return n?(o?o.location.replace(n):this.loggerService.logWarning(e,"CheckSession - init check session: IFrame contentWindow does not exist"),new ce(c=>{r.onload=()=>{this.lastIFrameRefresh=Date.now(),c.next(),c.complete()}})):(this.loggerService.logWarning(e,"CheckSession - init check session: checkSessionIframe is not configured to run"),g())}pollServerSession(e,t){this.outstandingMessages=0;let r=()=>{this.init(t).pipe(le(1)).subscribe(()=>{let n=this.getExistingIframe();if(n&&e){this.loggerService.logDebug(t,`CheckSession - clientId : '${e}' - existingIframe: '${n}'`);let o=this.storagePersistenceService.read("session_state",t),c=this.storagePersistenceService.read("authWellKnownEndPoints",t),l=n.contentWindow;if(o&&c?.checkSessionIframe&&l){let u=new URL(c.checkSessionIframe)?.origin;this.outstandingMessages++,l.postMessage(e+" "+o,u)}else this.loggerService.logDebug(t,`CheckSession - session_state is '${o}' - AuthWellKnownEndPoints is '${JSON.stringify(c,null,2)}'`),this.checkSessionChangedInternal$.next(!0)}else this.loggerService.logWarning(t,`CheckSession - OidcSecurityCheckSession pollServerSession checkSession IFrame does not exist:
               clientId : '${e}' - existingIframe: '${n}'`);this.outstandingMessages>3&&this.loggerService.logError(t,`CheckSession - OidcSecurityCheckSession not receiving check session response messages.
                            Outstanding messages: '${this.outstandingMessages}'. Server unreachable?`),this.zone.runOutsideAngular(()=>{this.scheduledHeartBeatRunning=this.document?.defaultView?.setTimeout(()=>this.zone.run(r),this.heartBeatInterval)??null})})};r()}clearScheduledHeartBeat(){this.scheduledHeartBeatRunning!==null&&(clearTimeout(this.scheduledHeartBeatRunning),this.scheduledHeartBeatRunning=null)}messageHandler(e,t){let r=this.getExistingIframe(),o=!!this.storagePersistenceService.read("authWellKnownEndPoints",e)?.checkSessionIframe?.startsWith(t.origin);this.outstandingMessages=0,r&&o&&t.source===r.contentWindow&&(t.data==="error"?this.loggerService.logWarning(e,"CheckSession - error from check session messageHandler"):t.data==="changed"?(this.loggerService.logDebug(e,`CheckSession - ${t} from check session messageHandler`),this.checkSessionReceived=!0,this.eventService.fireEvent(P.CheckSessionReceived,t.data),this.checkSessionChangedInternal$.next(!0)):(this.eventService.fireEvent(P.CheckSessionReceived,t.data),this.loggerService.logDebug(e,`CheckSession - ${t.data} from check session messageHandler`)))}bindMessageEventToIframe(e){let t=this.document.defaultView;this.iframeMessageEventListener&&t&&t.removeEventListener("message",this.iframeMessageEventListener,!1),this.iframeMessageEventListener=this.messageHandler.bind(this,e),t&&t.addEventListener("message",this.iframeMessageEventListener,!1)}getOrCreateIframe(e){return this.getExistingIframe()||this.iFrameService.addIFrameToWindowBody($t,e)}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),Ce=(()=>{let s=class s{constructor(){this.popUp=null,this.handle=-1,this.loggerService=a(S),this.storagePersistenceService=a(E),this.document=a(U),this.STORAGE_IDENTIFIER="popupauth",this.resultInternal$=new ge}get result$(){return this.resultInternal$.asObservable()}get windowInternal(){return this.document.defaultView}isCurrentlyInPopup(e){if(this.canAccessSessionStorage()){let t=this.storagePersistenceService.read(this.STORAGE_IDENTIFIER,e),r=this.windowInternal;return r?!!r.opener&&r.opener!==r&&!!t:!1}return!1}openPopUp(e,t,r){let n=this.getOptions(t);this.storagePersistenceService.write(this.STORAGE_IDENTIFIER,"true",r);let o=this.windowInternal;if(!o)return;if(!e){this.loggerService.logError(r,"Could not open popup, url is empty");return}if(this.popUp=o.open(e,"_blank",n),!this.popUp){this.storagePersistenceService.remove(this.STORAGE_IDENTIFIER,r),this.loggerService.logError(r,"Could not open popup");return}this.loggerService.logDebug(r,"Opened popup with url "+e);let c=l=>{if(!l?.data||typeof l.data!="string"){if(r.disableCleaningPopupOnInvalidMessage)return;this.cleanUp(c,r);return}this.loggerService.logDebug(r,"Received message from popup with url "+l.data),this.resultInternal$.next({userClosed:!1,receivedUrl:l.data}),this.cleanUp(c,r)};o.addEventListener("message",c,!1),this.handle=o.setInterval(()=>{this.popUp?.closed&&(this.resultInternal$.next({userClosed:!0,receivedUrl:""}),this.cleanUp(c,r))},200)}sendMessageToMainWindow(e,t){let r=this.windowInternal;if(r&&r.opener){let n=r.location.href;this.sendMessage(e,n,t)}}cleanUp(e,t){let r=this.windowInternal;r&&(r.removeEventListener("message",e,!1),r.clearInterval(this.handle),this.popUp&&(this.storagePersistenceService.remove(this.STORAGE_IDENTIFIER,t),this.popUp.close(),this.popUp=null))}sendMessage(e,t,r){let n=this.windowInternal;if(n){if(!e){this.loggerService.logDebug(r,`Can not send message to parent, no url: '${e}'`);return}n.opener.postMessage(e,t)}}getOptions(e){let t={width:500,height:500,left:50,top:50},r=y(y({},t),e||{}),n=this.windowInternal;if(!n)return"";let o=r.width||t.width,c=r.height||t.height,l=n.screenLeft+(n.outerWidth-o)/2,u=n.screenTop+(n.outerHeight-c)/2;return r.left=l,r.top=u,Object.entries(r).map(([h,v])=>`${encodeURIComponent(h)}=${encodeURIComponent(v)}`).join(",")}canAccessSessionStorage(){return typeof navigator<"u"&&navigator.cookieEnabled&&typeof Storage<"u"}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),es=(()=>{let s=class s{constructor(){this.document=a(U)}getStateParamFromCurrentUrl(e){let t=e||this.getCurrentUrl();if(!t)return null;let r=new URL(t);return new URLSearchParams(r.search).get("state")}getCurrentUrl(){return this.document?.defaultView?.location.toString()??null}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),Ye=(()=>{let s=class s{constructor(){this.checkSessionService=a(Xe),this.currentUrlService=a(es),this.silentRenewService=a(Qe),this.userService=a(te),this.loggerService=a(S),this.authStateService=a(W),this.callbackService=a(zt),this.refreshSessionService=a(Qt),this.periodicallyTokenCheckService=a(Zr),this.popupService=a(Ce),this.autoLoginService=a(mr),this.storagePersistenceService=a(E),this.publicEventsService=a(B)}checkAuth(e,t,r){if(!e)return p(()=>new Error("Please provide a configuration before setting up the module"));this.publicEventsService.fireEvent(P.CheckingAuth);let n=this.currentUrlService.getStateParamFromCurrentUrl(r);return this.getConfig(e,r)?this.checkAuthWithConfig(e,t,r):p(()=>new Error(`could not find matching config for state ${n}`))}checkAuthMultiple(e,t){let r=this.currentUrlService.getStateParamFromCurrentUrl(t);if(r){let c=this.getConfigurationWithUrlState(e,r);return c?this.composeMultipleLoginResults(e,c,t):p(()=>new Error(`could not find matching config for state ${r}`))}let n=e,o=n.map(c=>this.checkAuthWithConfig(c,n,t));return G(o)}checkAuthIncludingServer(e,t){return e?this.checkAuthWithConfig(e,t).pipe(D(r=>{let{isAuthenticated:n}=r;return n?g(r):this.refreshSessionService.forceRefreshSession(e,t).pipe(T(o=>{o?.isAuthenticated&&this.startCheckSessionAndValidation(e,t)}))})):p(()=>new Error("Please provide a configuration before setting up the module"))}getConfig(e,t){let r=this.currentUrlService.getStateParamFromCurrentUrl(t);return r?this.getConfigurationWithUrlState([e],r):e}checkAuthWithConfig(e,t,r){if(!e){let h="Please provide at least one configuration before setting up the module";return this.loggerService.logError(e,h),g({isAuthenticated:!1,errorMessage:h,userData:null,idToken:"",accessToken:"",configId:""})}let n=r||this.currentUrlService.getCurrentUrl();if(!n){let h="No URL found!";return this.loggerService.logError(e,h),g({isAuthenticated:!1,errorMessage:h,userData:null,idToken:"",accessToken:"",configId:""})}let{configId:o,authority:c}=e;if(this.loggerService.logDebug(e,`Working with config '${o}' using '${c}'`),this.popupService.isCurrentlyInPopup(e))return this.popupService.sendMessageToMainWindow(n,e),g({isAuthenticated:!1,errorMessage:"",userData:null,idToken:"",accessToken:"",configId:""});let l=this.callbackService.isCallback(n,e);return this.loggerService.logDebug(e,`currentUrl to check auth with: '${n}'`),(l?this.callbackService.handleCallbackAndFireEvents(n,e,t):g({})).pipe(m(()=>{let h=this.authStateService.areAuthStorageTokensValid(e);return this.loggerService.logDebug(e,`checkAuth completed. Firing events now. isAuthenticated: ${h}`),h&&(this.startCheckSessionAndValidation(e,t),l||(this.authStateService.setAuthenticatedAndFireEvent(t),this.userService.publishUserDataIfExists(e,t))),this.publicEventsService.fireEvent(P.CheckingAuthFinished),{isAuthenticated:h,userData:this.userService.getUserDataFromStore(e),accessToken:this.authStateService.getAccessToken(e),idToken:this.authStateService.getIdToken(e),configId:o}}),T(({isAuthenticated:h})=>{h&&this.autoLoginService.checkSavedRedirectRouteAndNavigate(e)}),C(({message:h})=>(this.loggerService.logError(e,h),this.publicEventsService.fireEvent(P.CheckingAuthFinishedWithError,h),g({isAuthenticated:!1,errorMessage:h,userData:null,idToken:"",accessToken:"",configId:o}))))}startCheckSessionAndValidation(e,t){this.checkSessionService.isCheckSessionConfigured(e)&&this.checkSessionService.start(e),this.periodicallyTokenCheckService.startTokenValidationPeriodically(t,e),this.silentRenewService.isSilentRenewConfigured(e)&&this.silentRenewService.getOrCreateIframe(e)}getConfigurationWithUrlState(e,t){if(!t)return null;for(let r of e)if(this.storagePersistenceService.read("authStateControl",r)===t)return r;return null}composeMultipleLoginResults(e,t,r){let n=e.filter(l=>l.configId!==t.configId),o=this.checkAuthWithConfig(t,e,r),c=n.map(l=>{let{redirectUrl:u}=l;return this.checkAuthWithConfig(l,e,u)});return G([o,...c])}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),Ze=(()=>{let s=class s{constructor(){this.document=a(U)}redirectTo(e){this.document.location.href=e}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),_e=(()=>{let s=class s{constructor(){this.loggerService=a(S),this.flowHelper=a($)}hasConfigValidResponseType(e){return this.flowHelper.isCurrentFlowAnyImplicitFlow(e)||this.flowHelper.isCurrentFlowCodeFlow(e)?!0:(this.loggerService.logWarning(e,"module configured incorrectly, invalid response_type. Check the responseType in the config"),!1)}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),ts=(()=>{let s=class s{constructor(){this.loggerService=a(S),this.urlService=a(O),this.dataService=a(q),this.storagePersistenceService=a(E)}postParRequest(e,t){let r=new _;r=r.set("Content-Type","application/x-www-form-urlencoded");let n=this.storagePersistenceService.read("authWellKnownEndPoints",e);if(!n)return p(()=>new Error("Could not read PAR endpoint because authWellKnownEndPoints are not given"));let o=n.parEndpoint;return o?this.urlService.createBodyForParCodeFlowRequest(e,t).pipe(D(c=>this.dataService.post(o,c,e,r).pipe(Q(2),m(l=>(this.loggerService.logDebug(e,"par response: ",l),{expiresIn:l.expires_in,requestUri:l.request_uri})),C(l=>{let u="There was an error on ParService postParRequest";return this.loggerService.logError(e,u,l),p(()=>new Error(u))})))):p(()=>new Error("Could not read PAR endpoint from authWellKnownEndpoints"))}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),rs=(()=>{let s=class s{constructor(){this.loggerService=a(S),this.responseTypeValidationService=a(_e),this.urlService=a(O),this.redirectService=a(Ze),this.authWellKnownService=a(re),this.popupService=a(Ce),this.checkAuthService=a(Ye),this.parService=a(ts)}loginPar(e,t){if(!this.responseTypeValidationService.hasConfigValidResponseType(e)){this.loggerService.logError(e,"Invalid response type!");return}this.loggerService.logDebug(e,"BEGIN Authorize OIDC Flow, no auth data"),this.authWellKnownService.queryAndStoreAuthWellKnownEndPoints(e).pipe(D(()=>this.parService.postParRequest(e,t))).subscribe(r=>{this.loggerService.logDebug(e,"par response: ",r);let n=this.urlService.getAuthorizeParUrl(r.requestUri,e);if(this.loggerService.logDebug(e,"par request url: ",n),!n){this.loggerService.logError(e,`Could not create URL with param ${r.requestUri}: '${n}'`);return}t?.urlHandler?t.urlHandler(n):this.redirectService.redirectTo(n)})}loginWithPopUpPar(e,t,r,n){let{configId:o}=e;if(!this.responseTypeValidationService.hasConfigValidResponseType(e)){let c="Invalid response type!";return this.loggerService.logError(e,c),p(()=>new Error(c))}return this.loggerService.logDebug(e,"BEGIN Authorize OIDC Flow with popup, no auth data"),this.authWellKnownService.queryAndStoreAuthWellKnownEndPoints(e).pipe(D(()=>this.parService.postParRequest(e,r)),D(c=>{this.loggerService.logDebug(e,`par response: ${c}`);let l=this.urlService.getAuthorizeParUrl(c.requestUri,e);if(this.loggerService.logDebug(e,"par request url: ",l),!l){let u=`Could not create URL with param ${c.requestUri}: 'url'`;return this.loggerService.logError(e,u),p(()=>new Error(u))}return this.popupService.openPopUp(l,n,e),this.popupService.result$.pipe(le(1),D(u=>{let{userClosed:h,receivedUrl:v}=u;return h?g({isAuthenticated:!1,errorMessage:"User closed popup",userData:null,idToken:"",accessToken:"",configId:o}):this.checkAuthService.checkAuth(e,t,v)}))}))}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),ss=(()=>{let s=class s{constructor(){this.loggerService=a(S),this.responseTypeValidationService=a(_e),this.urlService=a(O),this.authWellKnownService=a(re),this.popupService=a(Ce),this.checkAuthService=a(Ye)}loginWithPopUpStandard(e,t,r,n){let{configId:o}=e;if(!this.responseTypeValidationService.hasConfigValidResponseType(e)){let c="Invalid response type!";return this.loggerService.logError(e,c),p(()=>new Error(c))}return this.loggerService.logDebug(e,"BEGIN Authorize OIDC Flow with popup, no auth data"),this.authWellKnownService.queryAndStoreAuthWellKnownEndPoints(e).pipe(D(()=>this.urlService.getAuthorizeUrl(e,r)),T(c=>this.popupService.openPopUp(c,n,e)),D(()=>this.popupService.result$.pipe(le(1),D(c=>{let{userClosed:l,receivedUrl:u}=c;return l?g({isAuthenticated:!1,errorMessage:"User closed popup",userData:null,idToken:"",accessToken:"",configId:o}):this.checkAuthService.checkAuth(e,t,u)}))))}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),is=(()=>{let s=class s{constructor(){this.loggerService=a(S),this.responseTypeValidationService=a(_e),this.urlService=a(O),this.redirectService=a(Ze),this.authWellKnownService=a(re),this.flowsDataService=a(F)}loginStandard(e,t){if(!this.responseTypeValidationService.hasConfigValidResponseType(e)){this.loggerService.logError(e,"Invalid response type!");return}this.loggerService.logDebug(e,"BEGIN Authorize OIDC Flow, no auth data"),this.flowsDataService.setCodeFlowInProgress(e),this.authWellKnownService.queryAndStoreAuthWellKnownEndPoints(e).subscribe(()=>{let{urlHandler:r}=t||{};this.flowsDataService.resetSilentRenewRunning(e),this.urlService.getAuthorizeUrl(e,t).subscribe(n=>{if(!n){this.loggerService.logError(e,"Could not create URL",n);return}r?r(n):this.redirectService.redirectTo(n)})})}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),ns=(()=>{let s=class s{constructor(){this.parLoginService=a(rs),this.popUpLoginService=a(ss),this.standardLoginService=a(is),this.storagePersistenceService=a(E),this.popupService=a(Ce)}login(e,t){if(!e)throw new Error("Please provide a configuration before setting up the module");let{usePushedAuthorisationRequests:r}=e;return t?.customParams&&this.storagePersistenceService.write("storageCustomParamsAuthRequest",t.customParams,e),r?this.parLoginService.loginPar(e,t):this.standardLoginService.loginStandard(e,t)}loginWithPopUp(e,t,r,n){if(!e)throw new Error("Please provide a configuration before setting up the module");if(this.popupService.isCurrentlyInPopup(e))return g({errorMessage:"There is already a popup open."});let{usePushedAuthorisationRequests:c}=e;return r?.customParams&&this.storagePersistenceService.write("storageCustomParamsAuthRequest",r.customParams,e),c?this.parLoginService.loginWithPopUpPar(e,t,r,n):this.popUpLoginService.loginWithPopUpStandard(e,t,r,n)}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})();function os(i){let s=y({},i);for(let d in i)(i[d]===void 0||i[d]===null)&&delete s[d];return s}var as=(()=>{let s=class s{constructor(){this.loggerService=a(S),this.dataService=a(q),this.storagePersistenceService=a(E),this.urlService=a(O),this.checkSessionService=a(Xe),this.resetAuthDataService=a(H),this.redirectService=a(Ze)}logoff(e,t,r){if(!e)return p(()=>new Error("Please provide a configuration before setting up the module"));this.loggerService.logDebug(e,"logoff, remove auth",r);let{urlHandler:n,customParams:o}=r||{},c=this.urlService.getEndSessionUrl(e,o);return c?this.checkSessionService.serverStateChanged(e)?(this.loggerService.logDebug(e,"Server State changed. Logoff was only locally. Returning."),g(null)):n?(this.loggerService.logDebug(e,`Custom UrlHandler found. Using this to handle logoff with url '${c}'`),n(c),this.resetAuthDataService.resetAuthorizationData(e,t),g(null)):this.logoffInternal(r,c,e,t):(this.loggerService.logDebug(e,"No endsessionUrl present. Logoff was only locally. Returning."),g(null))}logoffLocal(e,t){this.resetAuthDataService.resetAuthorizationData(e,t),this.checkSessionService.stop()}logoffLocalMultiple(e){e.forEach(t=>this.logoffLocal(t,e))}logoffAndRevokeTokens(e,t,r){if(!e)return p(()=>new Error("Please provide a configuration before setting up the module"));let{revocationEndpoint:n}=this.storagePersistenceService.read("authWellKnownEndPoints",e)||{};return n?this.storagePersistenceService.getRefreshToken(e)?this.revokeRefreshToken(e).pipe(D(o=>this.revokeAccessToken(e)),C(o=>{let c="revoke token failed";return this.loggerService.logError(e,c,o),p(()=>new Error(c))}),I(()=>this.logoff(e,t,r))):this.revokeAccessToken(e).pipe(C(o=>{let c="revoke accessToken failed";return this.loggerService.logError(e,c,o),p(()=>new Error(c))}),I(()=>this.logoff(e,t,r))):(this.loggerService.logDebug(e,"revocation endpoint not supported"),this.logoff(e,t,r))}revokeAccessToken(e,t){if(!e)return p(()=>new Error("Please provide a configuration before setting up the module"));let r=t||this.storagePersistenceService.getAccessToken(e),n=this.urlService.createRevocationEndpointBodyAccessToken(r,e);return this.sendRevokeRequest(e,n)}revokeRefreshToken(e,t){if(!e)return p(()=>new Error("Please provide a configuration before setting up the module"));let r=t||this.storagePersistenceService.getRefreshToken(e),n=this.urlService.createRevocationEndpointBodyRefreshToken(r,e);return this.sendRevokeRequest(e,n)}logoffInternal(e,t,r,n){let{logoffMethod:o,customParams:c}=e||{};if(!o||o==="GET")return this.redirectService.redirectTo(t),this.resetAuthDataService.resetAuthorizationData(r,n),g(null);let{state:l,logout_hint:u,ui_locales:h}=c||{},{clientId:v}=r,k=this.storagePersistenceService.getIdToken(r),A=this.urlService.getPostLogoutRedirectUrl(r),w=this.getHeaders(),{url:j}=this.urlService.getEndSessionEndpoint(r),V=os({id_token_hint:k,client_id:v,post_logout_redirect_uri:A,state:l,logout_hint:u,ui_locales:h});return this.resetAuthDataService.resetAuthorizationData(r,n),this.dataService.post(j,V,r,w)}sendRevokeRequest(e,t){let r=this.urlService.getRevocationEndpointUrl(e),n=this.getHeaders();return this.dataService.post(r,t,e,n).pipe(Q(2),D(o=>(this.loggerService.logDebug(e,"revocation endpoint post response: ",o),g(o))),C(o=>{let c="Revocation request failed";return this.loggerService.logError(e,c,o),p(()=>new Error(c))}))}getHeaders(){let e=new _;return e=e.set("Content-Type","application/x-www-form-urlencoded"),e}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),Xt=(()=>{let s=class s{constructor(){this.checkSessionService=a(Xe),this.checkAuthService=a(Ye),this.userService=a(te),this.tokenHelperService=a(De),this.configurationService=a(Ge),this.authStateService=a(W),this.flowsDataService=a(F),this.callbackService=a(zt),this.logoffRevocationService=a(as),this.loginService=a(ns),this.refreshSessionService=a(Qt),this.urlService=a(O),this.authWellKnownService=a(re),this.userData=Ne(this.userData$,{requireSync:!0}),this.authenticated=Ne(this.isAuthenticated$,{requireSync:!0})}get userData$(){return this.userService.userData$}get isAuthenticated$(){return this.authStateService.authenticated$}get checkSessionChanged$(){return this.checkSessionService.checkSessionChanged$}get stsCallback$(){return this.callbackService.stsCallback$}preloadAuthWellKnownDocument(e){return this.configurationService.getOpenIDConfiguration(e).pipe(I(t=>this.authWellKnownService.queryAndStoreAuthWellKnownEndPoints(t)))}getConfigurations(){return this.configurationService.getAllConfigurations()}getConfiguration(e){return this.configurationService.getOpenIDConfiguration(e)}getUserData(e){return this.configurationService.getOpenIDConfiguration(e).pipe(m(t=>this.userService.getUserDataFromStore(t)))}checkAuth(e,t){return this.configurationService.getOpenIDConfigurations(t).pipe(I(({allConfigs:r,currentConfig:n})=>this.checkAuthService.checkAuth(n,r,e)))}checkAuthMultiple(e){return this.configurationService.getOpenIDConfigurations().pipe(I(({allConfigs:t})=>this.checkAuthService.checkAuthMultiple(t,e)))}isAuthenticated(e){return this.configurationService.getOpenIDConfiguration(e).pipe(m(t=>this.authStateService.isAuthenticated(t)))}checkAuthIncludingServer(e){return this.configurationService.getOpenIDConfigurations(e).pipe(I(({allConfigs:t,currentConfig:r})=>this.checkAuthService.checkAuthIncludingServer(r,t)))}getAccessToken(e){return this.configurationService.getOpenIDConfiguration(e).pipe(m(t=>this.authStateService.getAccessToken(t)))}getIdToken(e){return this.configurationService.getOpenIDConfiguration(e).pipe(m(t=>this.authStateService.getIdToken(t)))}getRefreshToken(e){return this.configurationService.getOpenIDConfiguration(e).pipe(m(t=>this.authStateService.getRefreshToken(t)))}getAuthenticationResult(e){return this.configurationService.getOpenIDConfiguration(e).pipe(m(t=>this.authStateService.getAuthenticationResult(t)))}getPayloadFromIdToken(e=!1,t){return this.configurationService.getOpenIDConfiguration(t).pipe(m(r=>{let n=this.authStateService.getIdToken(r);return this.tokenHelperService.getPayloadFromToken(n,e,r)}))}getPayloadFromAccessToken(e=!1,t){return this.configurationService.getOpenIDConfiguration(t).pipe(m(r=>{let n=this.authStateService.getAccessToken(r);return this.tokenHelperService.getPayloadFromToken(n,e,r)}))}setState(e,t){return this.configurationService.getOpenIDConfiguration(t).pipe(m(r=>this.flowsDataService.setAuthStateControl(e,r)))}getState(e){return this.configurationService.getOpenIDConfiguration(e).pipe(m(t=>this.flowsDataService.getAuthStateControl(t)))}authorize(e,t){this.configurationService.getOpenIDConfiguration(e).subscribe(r=>this.loginService.login(r,t))}authorizeWithPopUp(e,t,r){return this.configurationService.getOpenIDConfigurations(r).pipe(I(({allConfigs:n,currentConfig:o})=>this.loginService.loginWithPopUp(o,n,e,t)))}forceRefreshSession(e,t){return this.configurationService.getOpenIDConfigurations(t).pipe(I(({allConfigs:r,currentConfig:n})=>this.refreshSessionService.userForceRefreshSession(n,r,e)))}logoffAndRevokeTokens(e,t){return this.configurationService.getOpenIDConfigurations(e).pipe(I(({allConfigs:r,currentConfig:n})=>this.logoffRevocationService.logoffAndRevokeTokens(n,r,t)))}logoff(e,t){return this.configurationService.getOpenIDConfigurations(e).pipe(I(({allConfigs:r,currentConfig:n})=>this.logoffRevocationService.logoff(n,r,t)))}logoffLocal(e){this.configurationService.getOpenIDConfigurations(e).subscribe(({allConfigs:t,currentConfig:r})=>this.logoffRevocationService.logoffLocal(r,t))}logoffLocalMultiple(){this.configurationService.getOpenIDConfigurations().subscribe(({allConfigs:e})=>this.logoffRevocationService.logoffLocalMultiple(e))}revokeAccessToken(e,t){return this.configurationService.getOpenIDConfiguration(t).pipe(I(r=>this.logoffRevocationService.revokeAccessToken(r,e)))}revokeRefreshToken(e,t){return this.configurationService.getOpenIDConfiguration(t).pipe(I(r=>this.logoffRevocationService.revokeRefreshToken(r,e)))}getEndSessionUrl(e,t){return this.configurationService.getOpenIDConfiguration(t).pipe(m(r=>this.urlService.getEndSessionUrl(r,e)))}getAuthorizeUrl(e,t){return this.configurationService.getOpenIDConfiguration(t).pipe(I(r=>this.urlService.getAuthorizeUrl(r,e?{customParams:e}:void 0)))}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),cs=(()=>{let s=class s{read(e){return sessionStorage.getItem(e)}write(e,t){sessionStorage.setItem(e,t)}remove(e){sessionStorage.removeItem(e)}clear(){sessionStorage.clear()}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})();function Yt(i,...s){let d=ls(i);for(let e of s)d.push(...e.\u0275providers);return at(d)}function ls(i){return[{provide:Mt,useValue:i},i?.loader||{provide:be,useFactory:cr,deps:[Mt]},{provide:jt,useClass:cs},{provide:Ht,useClass:lr}]}function Zt(i){return i.reduce((s,d)=>s.concat(Array.isArray(d)?Zt(d):d),[])}function us(i){let s=hs(i);return new RegExp(`^${s}$`)}function hs(i){return i.replace(/[.+?^${}()|[\]\\]/g,"\\$&").replace(/\*/g,".*")}var ds=(()=>{let s=class s{getConfigIdForClosestMatchingRoute(e,t){for(let r of t){let{secureRoutes:n}=r,o=(n??[]).find(c=>this.routeMatches(c,e));if(o)return{matchingRoute:o,matchingConfig:r}}return{matchingRoute:null,matchingConfig:null}}routeMatches(e,t){return t.startsWith(e)||this.matchesRoute(e,t)}matchesRoute(e,t){return us(e).test(t)}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})(),_t=(()=>{let s=class s{constructor(){this.authStateService=a(W),this.configurationService=a(Ge),this.loggerService=a(S),this.closestMatchingRouteService=a(ds)}intercept(e,t){return gs(e,t.handle,{configurationService:this.configurationService,authStateService:this.authStateService,closestMatchingRouteService:this.closestMatchingRouteService,loggerService:this.loggerService})}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=f({token:s,factory:s.\u0275fac});let i=s;return i})();function gs(i,s,d){if(!d.configurationService.hasAtLeastOneConfig())return s(i);let e=d.configurationService.getAllConfigurations(),t=e.map(l=>l.secureRoutes||[]);if(Zt(t).length===0)return d.loggerService.logDebug(e[0],"No routes to check configured"),s(i);let{matchingConfig:n,matchingRoute:o}=d.closestMatchingRouteService.getConfigIdForClosestMatchingRoute(i.url,e);if(!n)return d.loggerService.logDebug(e[0],`Did not find any configured route for route ${i.url}`),s(i);d.loggerService.logDebug(n,`'${i.url}' matches configured route '${o}'`);let c=d.authStateService.getAccessToken(n);return c?(d.loggerService.logDebug(n,`'${i.url}' matches configured route '${o}', adding token`),i=i.clone({headers:i.headers.set("Authorization","Bearer "+c)}),s(i)):(d.loggerService.logDebug(n,`Wanted to add token to ${i.url} but found no token: '${c}'`),s(i))}var er={production:!1,serviceUrl:"https://d-cap-blog-backend---v2.whitepond-b96fee4b.westeurope.azurecontainerapps.io"};var J=class J{constructor(){this.isAuthenticatedSignal=X(!1);this.userDataSignal=X(null);this.isAuthenticated=x(()=>this.isAuthenticatedSignal());this.userData=x(()=>this.userDataSignal());this.username=x(()=>{let s=this.userDataSignal();return s?.preferred_username||s?.email||"student@hftm.ch"})}login(){console.log("MockAuth: Simulating login..."),this.userDataSignal.set({preferred_username:"student@hftm.ch",email:"student@hftm.ch",realm_access:{roles:["user","default-roles-blog"]},resource_access:{"spa-blog":{roles:["user"]}}}),this.isAuthenticatedSignal.set(!0),console.log("MockAuth: Login successful")}logout(){console.log("MockAuth: Logging out..."),this.isAuthenticatedSignal.set(!1),this.userDataSignal.set(null),console.log("MockAuth: Logout successful")}hasRole(s,d){let e=this.userDataSignal();if(!e)return!1;let t=e.realm_access?.roles||[],r=d?e.resource_access?.[d]?.roles||[]:[];return[...t,...r].includes(s)}};J.\u0275fac=function(d){return new(d||J)},J.\u0275prov=f({token:J,factory:J.\u0275fac,providedIn:"root"});var ie=J;var tr=()=>{let i=a(ie),s=a(ee);return i.isAuthenticated()&&i.hasRole("user","spa-blog")?!0:(s.navigateByUrl("/"),!1)};var rr=[{path:"",loadComponent:()=>import("./chunk-FAMN2UQT.js").then(i=>i.HomePageComponent),data:{preload:!0}},{path:"blog/:id",loadComponent:()=>import("./chunk-SAV7IEIJ.js").then(i=>i.BlogDetailComponent),data:{preload:!0}},{path:"add-blog",loadChildren:()=>import("./chunk-3P6OTWKW.js").then(i=>i.addBlogPageRoutes),canActivate:[tr]}];var sr={providers:[ft({eventCoalescing:!0}),Et(rr,Ct(At)),je(bt([Pt]),Ve()),Yt({config:{authority:"/realms/blog",redirectUrl:window.location.origin,postLogoutRedirectUri:window.location.origin,clientId:"spa-blog",scope:"openid profile email offline_access",responseType:"code",silentRenew:!1,useRefreshToken:!1,logLevel:z.Debug,secureRoutes:[er.serviceUrl],autoUserInfo:!0}}),{provide:yt,useClass:_t,multi:!0}]};function vs(i,s){i&1&&(K(0,"button",8),Z(1,"Add Blog"),L())}function Ss(i,s){if(i&1&&(K(0,"span",9),Z(1),L()),i&2){let d=ke();Y(),gt(d.username())}}function ws(i,s){if(i&1){let d=Oe();K(0,"button",10),$e("click",function(){Ue(d);let t=ke();return Me(t.login())}),Z(1,"Login"),L()}}function ms(i,s){if(i&1){let d=Oe();K(0,"button",11),$e("click",function(){Ue(d);let t=ke();return Me(t.logout())}),Z(1,"Logout"),L()}}var ne=class ne{constructor(){this.mockAuth=a(ie);this.isAuthenticated=x(()=>this.mockAuth.isAuthenticated());this.username=x(()=>this.mockAuth.username());this.canAddBlog=x(()=>this.isAuthenticated()&&this.mockAuth.hasRole("user","spa-blog"))}login(){this.mockAuth.login()}logout(){this.mockAuth.logout()}};ne.\u0275fac=function(d){return new(d||ne)},ne.\u0275cmp=me({type:ne,selectors:[["app-header-mock"]],decls:9,vars:4,consts:[[2,"display","flex","align-items","center","justify-content","space-between","padding","12px 16px","border-bottom","1px solid #e0e0e0","background-color","#f0f0f0"],["routerLink","/",2,"text-decoration","none","color","inherit"],[2,"margin","0"],[2,"display","flex","gap","12px","align-items","center"],["routerLink","/add-blog","style","padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;",4,"ngIf"],["style","font-weight: bold;",4,"ngIf"],["style","padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;",3,"click",4,"ngIf"],["style","padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;",3,"click",4,"ngIf"],["routerLink","/add-blog",2,"padding","8px 16px","background","#007bff","color","white","border","none","border-radius","4px","cursor","pointer"],[2,"font-weight","bold"],[2,"padding","8px 16px","background","#28a745","color","white","border","none","border-radius","4px","cursor","pointer",3,"click"],[2,"padding","8px 16px","background","#dc3545","color","white","border","none","border-radius","4px","cursor","pointer",3,"click"]],template:function(d,e){d&1&&(K(0,"header",0)(1,"a",1)(2,"h3",2),Z(3,"Blog"),L()(),K(4,"div",3),ht(5,vs,2,0,"button",4)(6,Ss,2,1,"span",5)(7,ws,2,0,"button",6)(8,ms,2,0,"button",7),L()()),d&2&&(Y(5),ue("ngIf",e.canAddBlog()),Y(),ue("ngIf",e.isAuthenticated()),Y(),ue("ngIf",!e.isAuthenticated()),Y(),ue("ngIf",e.isAuthenticated()))},dependencies:[He,vt,ye,Dt],encapsulation:2,changeDetection:0});var Te=ne;var oe=class oe{constructor(s){this.blogService=s;this.title="angular-app-Blog-Vithursen-Murugaravi";this.blogs=[];this.oidcSecurityService=a(Xt)}ngOnInit(){console.log("AppComponent: Initializing OIDC service...");try{this.oidcSecurityService.checkAuth().subscribe({next:s=>{console.log("AppComponent: checkAuth response:",s),console.log("AppComponent: isAuthenticated:",s.isAuthenticated),console.log("AppComponent: userData:",s.userData)},error:s=>{console.error("AppComponent: checkAuth error:",s),console.error("AppComponent: Error details:",JSON.stringify(s,null,2))}})}catch(s){console.error("AppComponent: Error initializing OIDC:",s)}this.blogService.getBlogs().subscribe({next:s=>this.blogs=s,error:s=>console.error("Fehler beim Laden der Blogs:",s)})}};oe.\u0275fac=function(d){return new(d||oe)(ut(Tt))},oe.\u0275cmp=me({type:oe,selectors:[["app-root"]],decls:2,vars:0,template:function(d,e){d&1&&dt(0,"app-header-mock")(1,"router-outlet")},dependencies:[ye,Rt,Te],encapsulation:2});var Pe=oe;wt(Pe,sr).catch(i=>console.error(i));
